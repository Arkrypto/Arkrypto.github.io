---
date: 2024-12-29 00:00:00
permalink: /pages/9a8ad9/
author: 
  name: Arkrypto
  link: https://github.com/Arkrypto
title: åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ - åˆ†å¸ƒå¼ç³»ç»Ÿç»„æˆ
---

> è½¯ä»¶ä¸šçš„äººä¹äºåšè¿™æ ·çš„äº‹ â€”â€” æ‰¾ä¸€äº›è¯æ±‡ï¼Œå¹¶æŠŠå®ƒä»¬å¼•ç”³åˆ°å¤§é‡å¾®å¦™è€Œåˆäº’ç›¸çŸ›ç›¾çš„æ„ä¹‰ï¼Œä¾‹å¦‚â€œæ¶æ„â€
>
> ã€ŠPatterns of Enterprise Application Architectureã€‹

## åˆ†å¸ƒå¼ç³»ç»Ÿæ¦‚è¿°

åˆ†å¸ƒå¼ç³»ç»Ÿçš„å®šä¹‰ï¼šå¤šä¸ªè®¡ç®—æœºé€šè¿‡ç½‘ç»œååŒå·¥ä½œè€Œå¯¹å¤–è¡¨ç°ä¸ºä¸€ä¸ªæ•´ä½“

å…¸å‹åº”ç”¨

- åˆ†å¸ƒå¼æ•°æ®åº“ï¼ˆå¦‚ MongoDBã€HBaseï¼‰
- åˆ†å¸ƒå¼å­˜å‚¨ï¼ˆå¦‚ Hadoop HDFSã€Cephï¼‰
- åˆ†å¸ƒå¼è®¡ç®—ï¼ˆå¦‚ Sparkã€Flinkï¼‰
- å¾®æœåŠ¡æ¶æ„ï¼ˆå¦‚ Spring Cloudã€Dubboï¼‰

### ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿ

è¦è§£é‡Šä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¾—ä»åˆ†å¸ƒå¼æ¶æ„è¯´èµ·ï¼Œå®ƒå®šä¹‰äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°æ–¹æ³•ï¼Œå®ƒæè¿°äº†ç³»ç»Ÿçš„ç»“æ„ã€ç»„ä»¶å¦‚ä½•äº¤äº’ã€æ•°æ®å¦‚ä½•å­˜å‚¨ã€è®¡ç®—å¦‚ä½•åˆ†é…ç­‰ã€‚å¯ä»¥è¯´ï¼Œæ¶æ„æ˜¯é’¢ç­‹ï¼Œè€Œç³»ç»Ÿæ˜¯æ¥¼æˆ¿ï¼Œç³»ç»Ÿä¾èµ–äºæ¶æ„

å¸¸è§çš„åˆ†å¸ƒå¼æ¶æ„æ¨¡å¼

1. ä¸»ä»æ¶æ„ï¼ˆMaster-Slaveï¼‰ï¼šé€‚ç”¨äºæ•°æ®åº“è¯»å†™åˆ†ç¦»ï¼Œå¦‚ MySQL ä¸»ä»å¤åˆ¶
2. åˆ†ç‰‡æ¶æ„ï¼ˆShardingï¼‰ï¼šé€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯ï¼Œå¦‚ Elasticsearch æ•°æ®åˆ†ç‰‡
3. å¾®æœåŠ¡æ¶æ„ï¼ˆMicroservicesï¼‰ï¼šé€‚ç”¨äºä¼ä¸šçº§åº”ç”¨ï¼Œå¦‚ Spring Cloud/Dubbo
4. äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEDA, Event-Driven Architectureï¼‰ï¼šé€‚ç”¨äºé«˜ååä¸šåŠ¡ï¼Œå¦‚ Kafka æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†æ—¥å¿—æµ

åœ¨è¿™äº›æ¶æ„æ¨¡å¼ä¹‹ä¸Šï¼Œæ„å»ºäº†ä¸€ä¸ªä¸ªæ‰€è°“çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¦‚æœ€å¸¸è§çš„åº”ç”¨æ·˜å®ã€äº¬ä¸œç­‰ï¼Œéƒ½æ˜¯é‡‡ç”¨**å¾®æœåŠ¡æ¶æ„**çš„åˆ†å¸ƒå¼ç³»ç»Ÿ

é€šå¸¸ï¼ŒSpring å°å­ï¼ˆæ²¡é”™å°±æ˜¯æˆ‘ï¼‰å¼€å‘çš„æ‰€è°“åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œéƒ½æ˜¯æŒ‡çš„å¾®æœåŠ¡æ¶æ„ï¼ˆSpring Cloudï¼‰ä¸Šçš„åˆ†å¸ƒå¼ç³»ç»Ÿ

### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†å¸ƒå¼è®¾è®¡

åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒç‰¹ç‚¹

- å¤šæœºåä½œï¼šä»»åŠ¡ç”±å¤šä¸ªè®¡ç®—æœºåä½œå®Œæˆï¼Œè€Œéå•æœºå¤„ç†
- æ•°æ®å…±äº«ï¼šä¸åŒèŠ‚ç‚¹ä¹‹é—´å…±äº«æ•°æ®ï¼Œå¯èƒ½æ¶‰åŠæ•°æ®ä¸€è‡´æ€§é—®é¢˜
- å»ä¸­å¿ƒåŒ–ï¼šé¿å…å•ç‚¹æ•…éšœï¼Œæé«˜ç³»ç»Ÿå¯ç”¨æ€§
- å¹¶å‘æ€§ï¼šå¤šä¸ªèŠ‚ç‚¹å¯ä»¥å¹¶è¡Œå¤„ç†ä»»åŠ¡ï¼Œæé«˜ååé‡
- å®¹é”™èƒ½åŠ›ï¼šæŸäº›èŠ‚ç‚¹å®•æœºæ—¶ï¼Œç³»ç»Ÿä»èƒ½ç»§ç»­è¿è¡Œ

è¯´ç™½äº†ï¼Œå°±æ˜¯æ‰©å±•æ€§å¥½ã€ç¨³å®šæ€§é«˜ã€å®¹é”™å¼º â€”â€” æ‰€è°“â€œç‹¡å…”ä¸‰çªŸâ€

## å¾®æœåŠ¡æ¶æ„

### Spring Cloud

åˆšåˆšä¹Ÿè¯´åˆ°ï¼ŒSpring Cloud æ˜¯ Java ç”Ÿæ€ä¸­æœ€æˆç†Ÿçš„**å¾®æœåŠ¡æ¶æ„**è§£å†³æ–¹æ¡ˆä¹‹ä¸€

- **å¾®æœåŠ¡æ¶æ„ï¼ˆMicroservices Architectureï¼‰** æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ï¼Œå®ƒå°†åº”ç”¨æ‹†åˆ†ä¸º**å¤šä¸ªç‹¬ç«‹è¿è¡Œçš„æœåŠ¡**ï¼Œæ¯ä¸ªæœåŠ¡è´Ÿè´£å•ä¸€ä¸šåŠ¡åŠŸèƒ½ï¼ŒæœåŠ¡ä¹‹é—´é€šè¿‡ APIï¼ˆé€šå¸¸æ˜¯ HTTP+JSON æˆ– gRPCï¼‰è¿›è¡Œé€šä¿¡

Spring Cloud å°±æ˜¯ä¸“é—¨ç”¨äº**æ„å»ºã€ç®¡ç†å’Œç»´æŠ¤å¾®æœåŠ¡æ¶æ„**çš„æ¡†æ¶ï¼Œæä¾›äº†ä¸€æ•´å¥—å®Œæ•´çš„å¾®æœåŠ¡æ¶æ„è§£å†³æ–¹æ¡ˆï¼Œæ¶µç›–**æœåŠ¡æ³¨å†Œå‘ç°ã€è´Ÿè½½å‡è¡¡ã€é…ç½®ç®¡ç†ã€ç†”æ–­é™æµã€åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª**ç­‰å…³é”®åŠŸèƒ½

| ç»„ä»¶                         | ä½œç”¨           | å…·ä½“è€Œè¨€                                 |
| ---------------------------- | -------------- | ---------------------------------------- |
| Spring Cloud Eureka          | æœåŠ¡æ³¨å†Œä¸å‘ç° | è´Ÿè´£ç®¡ç†å¾®æœåŠ¡å®ä¾‹ï¼Œç±»ä¼¼äº DNS           |
| Spring Cloud LoadBalancer    | è´Ÿè½½å‡è¡¡       | è®©å¤šä¸ªå®ä¾‹å‡è¡¡æ¥æ”¶è¯·æ±‚                   |
| Spring Cloud OpenFeign       | æœåŠ¡è°ƒç”¨       | é€šè¿‡ HTTP è¿œç¨‹è°ƒç”¨å…¶ä»–å¾®æœåŠ¡             |
| Spring Cloud Gateway         | API ç½‘å…³       | ç»Ÿä¸€æµé‡å…¥å£ï¼Œè·¯ç”±è¯·æ±‚å¹¶æä¾›å®‰å…¨æ§åˆ¶     |
| Spring Cloud Config          | é…ç½®ç®¡ç†       | ç»Ÿä¸€ç®¡ç†åˆ†å¸ƒå¼ç³»ç»Ÿçš„é…ç½®                 |
| Spring Cloud Sleuth & Zipkin | åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª | ç›‘æ§è¯·æ±‚çš„è°ƒç”¨é“¾è·¯ï¼Œæ’æŸ¥æ€§èƒ½ç“¶é¢ˆ         |
| Spring Cloud Resilience4J    | ç†”æ–­é™æµ       | ä¿æŠ¤æœåŠ¡é¿å…é›ªå´©æ•ˆåº”ï¼ˆCircuit Breakerï¼‰  |
| Spring Cloud Stream          | æ¶ˆæ¯é˜Ÿåˆ—       | è®©æœåŠ¡é—´å¼‚æ­¥é€šä¿¡ï¼ˆæ”¯æŒ Kafkaã€RabbitMQï¼‰ |

SpringCloud ä¸»è¦åŸºäº SpringBoot

### ä¸€ä¸ªç»å…¸çš„ Spring Cloud æ¶æ„

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼ŒåŒ…å«

- ç”¨æˆ·æœåŠ¡ï¼ˆUser Serviceï¼‰
- è®¢å•æœåŠ¡ï¼ˆOrder Serviceï¼‰
- å•†å“æœåŠ¡ï¼ˆProduct Serviceï¼‰
- æ”¯ä»˜æœåŠ¡ï¼ˆPayment Serviceï¼‰
- ç½‘å…³ï¼ˆGatewayï¼‰

å…¶ä½“ç³»æ¶æ„å¦‚ä¸‹

```sql
                         +-----------------------+
                         | Spring Cloud Gateway  |
                         +-----------------------+
                                 |
        +------------------+------------------+
        |                  |                  |
+------------+      +------------+      +------------+
| ç”¨æˆ·æœåŠ¡    |      | è®¢å•æœåŠ¡    |      | å•†å“æœåŠ¡    |
| (User)     | <--> | (Order)    | <--> | (Product)  |
+------------+      +------------+      +------------+
        |                  |
        |                  +------------------+
        |                                     |
+------------+                      +----------------+
| æ”¯ä»˜æœåŠ¡    |                      | æ¶ˆæ¯é˜Ÿåˆ—(Kafka) |
| (Payment)   | <-----------------> | äº‹ä»¶é©±åŠ¨        |
+------------+                      +----------------+
```

åœ¨è¿™ä¸ªæ¶æ„ä¸­

- **Spring Cloud Gateway** å……å½“ API å…¥å£ï¼Œç®¡ç†æ‰€æœ‰ HTTP è¯·æ±‚
- **Eureka** ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰å¾®æœåŠ¡å®ä¾‹ï¼Œå®ç°**æœåŠ¡å‘ç°**
- **Feign** è®©æœåŠ¡ä¹‹é—´å¯ä»¥æ›´ä¼˜é›…åœ°ç›¸äº’è°ƒç”¨ï¼ˆç›´æ¥ä» Eureka ä¸­å¯»æ‰¾ï¼‰ï¼Œè€Œä¸ç”¨è‡ªå·±å†™ HTTP è¯·æ±‚
- **Resilience4J** ç¡®ä¿æœåŠ¡æ•…éšœæ—¶è‡ªåŠ¨ç†”æ–­ï¼Œé˜²æ­¢çº§è”æ•…éšœ
- **Kafka** å®ç°å¼‚æ­¥æ¶ˆæ¯é€šä¿¡ï¼ˆå¦‚è®¢å•å®Œæˆåé€šçŸ¥æ”¯ä»˜æœåŠ¡ï¼‰

### NIO å’Œ Netty

> Spring Cloud ç”Ÿæ€ä¸­ä¼—å¤šå¾®æœåŠ¡ç»„ä»¶çš„åº•å±‚é€šä¿¡ç»„ä»¶

Nettyï¼šåŸºäº Java NIO å¼€å‘çš„ç½‘ç»œæµæ¡†æ¶ï¼Œæ˜¯ Java é¢†åŸŸéå¸¸å¼ºå¤§çš„**é«˜æ€§èƒ½ç½‘ç»œé€šä¿¡æ¡†æ¶**ï¼Œå¾ˆå¤šä¸­é—´ä»¶ï¼ˆDubboã€Elasticsearchã€RocketMQã€gRPC ç­‰ï¼‰éƒ½ç”¨å®ƒä½œä¸ºåº•å±‚é€šä¿¡ç»„ä»¶

ç®€å•æ¥è¯´ï¼šNetty æ˜¯ **ä¸€ä¸ªå°è£…äº† Java NIO çš„ç½‘ç»œæ¡†æ¶**ï¼Œè®©å¼€å‘è€…èƒ½è½»æ¾æ„å»ºé«˜æ€§èƒ½çš„ TCP/UDP ç½‘ç»œæœåŠ¡ï¼Œè€Œä¸ç”¨è‡ªå·±å»å†™ç¹ççš„ Selectorã€Channelã€Buffer è¿™äº›ä½çº§ API

**ä»€ä¹ˆæ˜¯ NIOï¼Ÿ**

NIOï¼ˆNew Input/Outputï¼‰ æ˜¯ Java 1.4 å¼•å…¥çš„ä¸€ç»„ APIï¼Œç”¨äºæä¾›**éé˜»å¡ï¼ˆAsynchronousï¼‰**çš„è¾“å…¥è¾“å‡ºæ“ä½œï¼Œå®ƒè®©æˆ‘ä»¬èƒ½æ›´é«˜æ•ˆåœ°å¤„ç†å¤§é‡çš„ I/O æ“ä½œ

NIO ä¸»è¦çš„ä¼˜åŠ¿åœ¨äºèƒ½å¤Ÿ**ä¸é˜»å¡çº¿ç¨‹**æ¥å¤„ç† I/O æ“ä½œï¼Œå®ƒæ˜¯ä¸ºäº†å¼¥è¡¥ä¼ ç»Ÿçš„é˜»å¡ I/Oï¼ˆBIOï¼‰å’Œ é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½ç“¶é¢ˆè€Œè®¾è®¡çš„

- **æ€ä¹ˆå®ç°çš„éé˜»å¡ï¼Ÿ**

**Selector** å’Œ **Channel** æ˜¯ NIO çš„æ ¸å¿ƒç»„æˆï¼Œé€šè¿‡**äº‹ä»¶é©±åŠ¨**å®ç°å¼‚æ­¥éé˜»å¡ I/O æ“ä½œ

**Netty é«˜æ€§èƒ½çš„å…³é”®**

ğŸ”¹ 1. çº¿ç¨‹æ±  + äº‹ä»¶é©±åŠ¨

Netty é‡‡ç”¨å¤š Reactor çº¿ç¨‹æ¨¡å‹ï¼Œé€šè¿‡ **EventLoopGroup + çº¿ç¨‹æ± **ï¼Œé¿å…ä¼ ç»Ÿ BIO çš„**ä¸€çº¿ç¨‹ä¸€è¿æ¥**ä½æ•ˆæ¨¡å¼

- BIOï¼ˆé˜»å¡ IOï¼‰ï¼šä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªè¿æ¥
- NIOï¼ˆéé˜»å¡ IOï¼‰ï¼šå¤šä¸ªè¿æ¥å…±äº«ä¸€ä¸ªçº¿ç¨‹
- Nettyï¼ˆå¤š Reactor æ¨¡å‹ï¼‰ï¼šå¤šä¸ªçº¿ç¨‹æ± é«˜æ•ˆç®¡ç†è¿æ¥

ğŸ“Œ ç¤ºä¾‹ï¼šNetty çº¿ç¨‹æ± 

```java
EventLoopGroup bossGroup = new NioEventLoopGroup(1);  // å¤„ç†è¿æ¥
EventLoopGroup workerGroup = new NioEventLoopGroup(); // å¤„ç†è¯»å†™
```

ğŸ”¹ 2. é›¶æ‹·è´ï¼ˆZero-Copyï¼‰

Netty é€šè¿‡ **DirectByteBufã€CompositeByteBuf** è¿›è¡Œé›¶æ‹·è´ä¼˜åŒ–

- å‡å°‘ CPU æ‹·è´ï¼ˆé¿å… `System.arraycopy`ï¼‰
- å‡å°‘å†…å­˜åˆ†é…ï¼ˆå‡å°‘ GC å‹åŠ›ï¼‰
- **å‡å°‘ **Buffer** å¤åˆ¶**ï¼ˆç›´æ¥æ“ä½œå †å¤–å†…å­˜ï¼‰

ğŸ“Œ **ç¤ºä¾‹ï¼š**Netty ç›´æ¥ä½¿ç”¨å †å¤–å†…å­˜

```java
ByteBuf buffer = Unpooled.directBuffer(1024); // ç›´æ¥åˆ†é…å †å¤–å†…å­˜
```

ğŸ”¹ 3. Pooled Bufferï¼ˆæ± åŒ–å†…å­˜ï¼‰

Netty ä½¿ç”¨å†…å­˜æ± ï¼ˆBuffer Poolï¼‰ï¼Œé‡å¤åˆ©ç”¨ ByteBufï¼Œé¿å…åå¤åˆ›å»ºå¯¹è±¡

ğŸ“Œ ç¤ºä¾‹ï¼šä½¿ç”¨æ± åŒ–çš„ ByteBuf

```java
ByteBuf pooledBuf = PooledByteBufAllocator.DEFAULT.buffer(256);
```

ğŸ”¹ 4. TCP ç²˜åŒ…/æ‹†åŒ…å¤„ç†

TCP å‘é€æ•°æ®æ—¶ï¼Œå¤šä¸ªå°åŒ…å¯èƒ½åˆå¹¶æˆä¸€ä¸ªå¤§åŒ…ï¼ˆ**ç²˜åŒ…**ï¼‰ï¼Œæˆ–è€…ä¸€ä¸ªå¤§åŒ…è¢«æ‹†æˆå¤šä¸ªå°åŒ…ï¼ˆ**æ‹†åŒ…**ï¼‰ã€‚Netty é€šè¿‡**è§£ç å™¨**è§£å†³æ­¤é—®é¢˜

ğŸ“Œ ç¤ºä¾‹ï¼šä½¿ç”¨ Netty æä¾›çš„æ‹†åŒ…è§£ç å™¨

```java
ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 0, 4, 0, 4));
```

ä¸Šé¢è¿™ä¸ª LengthFieldBasedFrameDecoder è§£ç å™¨

- æŒ‰ç…§æ•°æ®åŒ…é•¿åº¦å­—æ®µè§£ææ¶ˆæ¯
- é¿å… TCP ç²˜åŒ…/æ‹†åŒ…é—®é¢˜

## å¸¸ç”¨ç»„ä»¶å’Œä¸­é—´ä»¶

### Nacos

> æ³¨å†Œä¸­å¿ƒæ˜¯**å¾®æœåŠ¡é€šä¿¡çš„æ ¸å¿ƒ**ï¼Œä¸ç®¡æ˜¯ Eurekaã€Feign è¿˜æ˜¯ Dubboï¼Œä»–ä»¬çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å‡è¦åœ¨æ³¨å†Œä¸­å¿ƒè¿›è¡ŒåŠ¨æ€ç®¡ç†

Nacos æ˜¯ SpringCloud Alibaba çš„ç»„ä»¶ï¼Œè€Œ SpringCloud Alibaba éµå¾ª SpringCloud ä¸­å®šä¹‰çš„æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°è§„èŒƒï¼Œå› æ­¤ä½¿ç”¨ Nacos å’Œä½¿ç”¨ Eureka å¯¹äºå¾®æœåŠ¡æ¥å£è€Œè¨€ï¼Œå¹¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«

å·®å¼‚æ— é

- ä¾èµ–ä¸åŒ
- æœåŠ¡åœ°å€ä¸åŒ

å…·ä½“è€Œè¨€ï¼Œæ¯ä¸ªå¾®æœåŠ¡é€šè¿‡è¿™æ ·çš„æ–¹å¼é›†ä¸­ç®¡ç†

1ï¸âƒ£ é¦–å…ˆå¼•å…¥ Nacos å®¢æˆ·ç«¯ä¾èµ–å¹¶è¿›è¡Œé…ç½®

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    <version>2022.0.0.0</version> <!-- æ ¹æ® Spring Cloud ç‰ˆæœ¬é€‰æ‹© -->
</dependency>
```

```yaml
server:
  port: 8081

spring:
  application:
    name: user-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848  # Nacos æœåŠ¡å™¨åœ°å€
        namespace: public           # å‘½åç©ºé—´ï¼ˆé»˜è®¤ publicï¼‰
        group: DEFAULT_GROUP        # åˆ†ç»„ï¼ˆé»˜è®¤ DEFAULT_GROUPï¼‰
```

2ï¸âƒ£ åœ¨ä¸»ç±»ä¸­å¯åŠ¨ Nacos æ³¨å†ŒæœåŠ¡

```java
package com.example.userservice;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient // å¯ç”¨æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼ˆå…¼å®¹ Nacosï¼‰
public class UserServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(UserServiceApplication.class, args);
    }
}
```

3ï¸âƒ£ æ­£å¸¸ç¼–å†™`Controller`å±‚ä»£ç ï¼Œå¦‚

```java
@RestController
@RequestMapping("/users")
class UserController {

    private final Map<Long, User> userMap = new HashMap<>();

    // åˆ›å»ºç”¨æˆ·
    @PostMapping
    public User createUser(@RequestBody User user) {
        userMap.put(user.getId(), user);
        return user;
    }

    // æŸ¥è¯¢ç”¨æˆ·
    @GetMapping("/{id}")
    public User getUser(@PathVariable Long id) {
        return userMap.get(id);
    }
}
```

å¦‚æ­¤ï¼Œå½“å‰é¡¹ç›®`user-service`çš„æ¥å£å°±è¢«æ³¨å†Œåœ¨åœ°å€ä¸º`localhost:8848`çš„ Nacos ä¸­ï¼Œå…¶ä»–æ¨¡å—å¯ä»¥é€šè¿‡ Feign å®¢æˆ·ç«¯å¯¹è¯¥æ¥å£è¿›è¡Œè°ƒç”¨

```java
@FeignClient(name = "user-service") // æœåŠ¡åéœ€ä¸ç›®æ ‡æœåŠ¡åœ¨ Nacos ä¸­çš„åç§°ä¸€è‡´
public interface UserServiceClient {

    @GetMapping("/{id}}")
    User getUserById(@PathVariable Long userId);
}
```

### Feign

> SpringCloud OpenFeignï¼Œæœ¬è´¨ä¸Šæ˜¯ RestTemplate çš„ä¸Šä½æ›¿ä»£ï¼Œå°è£…äº† HTTP è¯·æ±‚åœ¨å„å¾®æœåŠ¡æ¥å£ä¹‹é—´è¿›è¡Œè°ƒç”¨ï¼Œå±åŒæ­¥è°ƒç”¨ï¼Œä¸å±äº RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰

åˆšåˆšç®€å•å±•ç¤ºäº†è°ƒç”¨ user-service çš„ Feign å®¢æˆ·ç«¯ç¼–å†™ï¼Œä»¥ä¸‹å¼•å…¥å¦ä¸€ä¸ªæ¨¡å— order-service æ¥æ›´æ¸…æ™°çš„å±•ç¤ºè°ƒç”¨è¿‡ç¨‹

ä»¥åŒæ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª order-service æ¨¡å—è¿è¡Œåœ¨ 8082 ç«¯å£ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¢å•æŸ¥è¯¢æ¥å£æ³¨å†Œåˆ° Nacos

```yaml
server:
  port: 8082

spring:
  application:
    name: order-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848  # Nacos æœåŠ¡å™¨åœ°å€
        namespace: public           # å‘½åç©ºé—´ï¼ˆé»˜è®¤ publicï¼‰
        group: DEFAULT_GROUP        # åˆ†ç»„ï¼ˆé»˜è®¤ DEFAULT_GROUPï¼‰
```

```java
@RestController
@RequestMapping("/orders")
class OrderController {
    // æŸ¥è¯¢ç”¨æˆ·è´¦å•
    @GetMapping("/{userId}")
    public List<Order> getOrders(@PathVariable Long id) {
        return OrderService.getOrdersByUserId(id);
    }
}
```

ä»¥ä¸‹å±•ç¤ºå¦‚ä½•åœ¨ user-service æ¨¡å—ä¸­è°ƒç”¨ä¸Šé¢æ³¨å†Œåˆ° Nacos çš„ order-service æœåŠ¡

1ï¸âƒ£ å¼•å…¥ Feign ä¾èµ–å¹¶åœ¨ä¸»ç±»ä¸­å¯ç”¨ï¼ˆåœ¨ UserService æ¨¡å—ä¸­ï¼‰

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

```java
@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients // å¯ç”¨ Feign å®¢æˆ·ç«¯
public class UserServiceApplication {
    // ...
}
```

3ï¸âƒ£ ç¼–å†™ Feign å®¢æˆ·ç«¯è°ƒç”¨ä¸Šé¢ order-service çš„æœåŠ¡

```java
@FeignClient(name = "order-service") // æœåŠ¡åéœ€ä¸ç›®æ ‡æœåŠ¡åœ¨ Nacos ä¸­çš„åç§°ä¸€è‡´
public interface OrderServiceClient {
    @GetMapping("/orders/{userId}")
    List<Order> getOrdersByUserId(@PathVariable Long userId);
}
```

4ï¸âƒ£ åœ¨ Controller å±‚è°ƒç”¨ Feign å®¢æˆ·ç«¯

```java
@RestController
@RequestMapping("/users")
class UserController {

    @Autowired
    private OrderServiceClient orderServiceClient;

    @GetMapping("/{id}/orders")
    public List<Order> getUserOrders(@PathVariable Long id) {
        return orderServiceClient.getOrdersByUserId(id);
    }
}
```

å¦‚æ­¤ä¾¿å®ç°äº†å¾®æœåŠ¡ä¹‹é—´çš„ä¸€æ¬¡ç®€å•çš„è°ƒç”¨ï¼Œå¯¹äºç”¨æˆ·è€Œè¨€ï¼Œä»–è¯·æ±‚çš„å®é™…ä¸Šæ˜¯`/users/{id}/orders`æ¥å£ï¼Œåœ¨å¾®æœåŠ¡å†…éƒ¨ï¼Œè¿™ä¸ªè¯·æ±‚è¢«è½¬å‘åˆ°`/orders/{id}`æ¥å£ï¼Œå¹¶æœ€ç»ˆå°†ç»“æœé€šè¿‡`/users/{id}/orders`è¿”å›

### Gateway

Gateway ç½‘å…³æ˜¯å¾®æœåŠ¡çš„é—¨ç¥ï¼Œè´Ÿè´£

- **æƒé™æ§åˆ¶**ï¼šç½‘å…³ä½œä¸ºå¾®æœåŠ¡å…¥å£ï¼Œéœ€è¦æ ¡éªŒç”¨æˆ·æ˜¯æ˜¯å¦æœ‰è¯·æ±‚èµ„æ ¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›è¡Œæ‹¦æˆª
- **è·¯ç”±å’Œè´Ÿè½½å‡è¡¡**ï¼šä¸€åˆ‡è¯·æ±‚éƒ½å¿…é¡»å…ˆç»è¿‡gatewayï¼Œä½†ç½‘å…³ä¸å¤„ç†ä¸šåŠ¡ï¼Œè€Œæ˜¯æ ¹æ®æŸç§è§„åˆ™ï¼ŒæŠŠè¯·æ±‚è½¬å‘åˆ°æŸä¸ªå¾®æœåŠ¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšè·¯ç”±ã€‚å½“ç„¶è·¯ç”±çš„ç›®æ ‡æœåŠ¡æœ‰å¤šä¸ªæ—¶ï¼Œè¿˜éœ€è¦åšè´Ÿè½½å‡è¡¡
- **é™æµ**ï¼šå½“è¯·æ±‚æµé‡è¿‡é«˜æ—¶ï¼Œåœ¨ç½‘å…³ä¸­æŒ‰ç…§ä¸‹æµçš„å¾®æœåŠ¡èƒ½å¤Ÿæ¥å—çš„é€Ÿåº¦æ¥æ”¾è¡Œè¯·æ±‚ï¼Œé¿å…æœåŠ¡å‹åŠ›è¿‡å¤§

åŸºæœ¬æ¶æ„

<img src="./assets/2729274-20230205163347683-397320818.png">

**å®é™…ä¸Šï¼Œåœ¨ç°å®ä¸šåŠ¡ä¸­ï¼Œè¯·æ±‚å…ˆèµ°è´Ÿè½½å‡è¡¡ï¼Œå†æ‰“ç½‘å…³ï¼Œæœ€åæ‰“åˆ°å¾®æœåŠ¡**

maven å¼•å…¥

```xml
<!--ç½‘å…³-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
<!--nacosæœåŠ¡å‘ç°ä¾èµ– è‡ªå·±ä¹Ÿè¦æ³¨å†Œåˆ°nacos-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

application é…ç½®

```yaml
server:
  port: 10010 # ç½‘å…³ç«¯å£
spring:
  application:
    name: gateway # æœåŠ¡åç§°
  cloud:
    nacos:
      server-addr: localhost:8848 # nacosåœ°å€
    gateway:
      routes: # ç½‘å…³è·¯ç”±é…ç½®
        - id: order-service
          uri: lb://orderservice
          predicates:
            - Path=/user/**
            - After=2021-01-20T17:42:47.789-07:00[America/Denver] #æ–­è¨€ï¼šåªæœ‰åœ¨è¿™ä¸ªäº‹ä»¶åå‘é€çš„è¯·æ±‚æ‰å¯ä»¥
        - id: user-service # è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯
          # uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€
          uri: lb://userservice # è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°
          predicates: # è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶
            - Path=/user/** # è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚
          filters: # è¿‡æ»¤å™¨ï¼ˆå½“å‰è¿‡æ»¤å™¨å†™åœ¨userserviceè·¯ç”±ä¸‹ï¼Œå› æ­¤ä»…ä»…å¯¹è®¿é—®userserviceçš„è¯·æ±‚æœ‰æ•ˆï¼‰
            - AddRequestHeader=Conan, isMe! # æ·»åŠ è¯·æ±‚å¤´
      default-filters: # é»˜è®¤è¿‡æ»¤é¡¹ï¼ˆå¯¹æ‰€æœ‰è·¯ç”±éƒ½æœ‰æ•ˆï¼‰
        - AddRequestHeader=Truth, Itcast is freaking awesome!
```

æœ‰ä¸€ä¸ªé—®é¢˜ï¼šGateway çš„æƒé™æ‹¦æˆªå’Œ SpringSecurity æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œèƒ½å¦ç›¸äº’æ›¿ä»£ï¼Ÿ

## RPC æ¡†æ¶

è¯¦è§ [åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ - æ·±å…¥ RPC æ¡†æ¶ | Arkrypto's Wiki](https://arkrypto.github.io/pages/2afee4/)

## æ¶ˆæ¯é˜Ÿåˆ—

è¿™é‡Œé‡ç‚¹è€ƒè™‘ Kafka çš„ä½¿ç”¨ï¼Œå¦‚æœæ˜¯ä¸šåŠ¡è§£è€¦å¯ä»¥æ›´å¤šå‚è€ƒ RabbitMQï¼Œè¯¦è§ [RabbitMQ | Arkrypto's Wiki](https://arkrypto.github.io/pages/45216b/)

Kafka æ˜¯ä¸€ä¸ªæµå¼æ¡†æ¶ï¼Œè®¾è®¡æœ¬èº«å°±æ˜¯ä¸ºäº†æµå¤„ç†å’Œæ‰¹å¤„ç†ï¼Œä»¥é¢å¯¹å¤§æ•°æ®çš„å†²å‡»å’Œæ¶ˆè´¹ï¼Œä¾‹å¦‚æ—¥å¿—å¤„ç†

## å¤§æ•°æ®è®¡ç®—

### Flink

åœ¨å¤§æ•°æ®åœºæ™¯ä¸­ï¼ŒFlink ç»å¸¸å’Œ Kafka æ­é…ï¼Œç”¨æ¥æ¶ˆè´¹ Kafka çš„æ•°æ®æµ

1. Kafka ç”Ÿäº§æ•°æ®ï¼ˆæ—¥å¿—ã€ç”¨æˆ·ç‚¹å‡»ã€è®¾å¤‡æ•°æ®ç­‰ï¼‰
2. Flink è¿›è¡Œå®æ—¶å¤„ç†ï¼ˆèšåˆã€åˆ†æã€æ¸…æ´—ï¼‰
3. å¤„ç†ç»“æœå­˜å…¥ Kafkaï¼ˆæœ¬åœ°ç£ç›˜ï¼‰ / å…³ç³»å‹æ•°æ®åº“ / Elasticsearch

ğŸ“Œ ç¤ºä¾‹ï¼šFlink è¯»å– Kafka å¹¶ç»Ÿè®¡ç”¨æˆ·ç‚¹å‡»é‡

```java
StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
FlinkKafkaConsumer<String> kafkaConsumer = new FlinkKafkaConsumer<>("user_clicks", new SimpleStringSchema(), properties);
DataStream<String> stream = env.addSource(kafkaConsumer);

// ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„ç‚¹å‡»æ¬¡æ•°
stream.map(value -> new Tuple2<>(value, 1))
      .keyBy(0)
      .sum(1)
      .print();

env.execute("Kafka Stream Processing");
```

### Spark

Flink ä¸“æ³¨äºæµå¤„ç†ï¼Œè€Œ Spark ä»¥æ‰¹å¤„ç†ä¸ºä¸»

| **å¯¹æ¯”é¡¹**     | **Flink**                         | **Spark**                    |
| -------------- | --------------------------------- | ---------------------------- |
| **è®¡ç®—æ¨¡å¼**   | ä¸»è¦æ˜¯**æµè®¡ç®—**ï¼Œä¹Ÿæ”¯æŒæ‰¹å¤„ç†    | ä¸»è¦æ˜¯**æ‰¹å¤„ç†**ï¼Œæ”¯æŒæµè®¡ç®— |
| **å»¶è¿Ÿ**       | æ¯«ç§’çº§                            | ç§’çº§                         |
| **ååé‡**     | é«˜ååï¼Œé€‚ç”¨äºé«˜å¹¶å‘              | è¾ƒé«˜ååï¼Œä½†ç¨é€Šäº Flink     |
| **æ•…éšœæ¢å¤**   | Exactly-Once è¯­ä¹‰ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ | At-Least-Onceï¼Œå¯èƒ½é‡å¤è®¡ç®—  |
| **API å…¼å®¹æ€§** | æä¾› SQLã€Javaã€Python API        | æä¾› SQLã€Scalaã€Java API    |

## ElasticSearch 

[ElasticSearch (ESä»å…¥é—¨åˆ°ç²¾é€šä¸€ç¯‡å°±å¤Ÿäº†) - ä¸åƒç´«èœ - åšå®¢å›­](https://www.cnblogs.com/buchizicai/p/17093719.html)

### ELK

ELKï¼ŒElastic Stackï¼Œæ˜¯ä»¥ ElasticSearch ä¸ºæ ¸å¿ƒçš„æŠ€æœ¯æ ˆï¼ŒåŒ…æ‹¬ Beatsã€**Logstash**ã€Kibanaã€**ElasticSerach**ï¼Œè¢«å¹¿æ³›åº”ç”¨åœ¨æ—¥å¿—æ•°æ®åˆ†æã€å®æ—¶ç›‘æ§ç­‰é¢†åŸŸ

<img src="./assets/2729274-20230205171722024-1222796164.png">

ä½œä¸º ELK çš„æ ¸å¿ƒï¼ŒElasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼ˆç´¢å¼•æ•°æ®åº“ï¼‰ï¼Œè´Ÿè´£å­˜å‚¨ã€æœç´¢ã€åˆ†ææ•°æ®ã€‚ä»–é‡‡ç”¨ Netty ä½œä¸ºåº•å±‚é€šä¿¡æ¡†æ¶ï¼Œæ¥å®ç°é«˜æ•ˆçš„ **TCP è¿æ¥ç®¡ç†**å’Œ**æ•°æ®ä¼ è¾“**ï¼Œç”± Lucene æä¾›æœç´¢å¼•æ“çš„æ ¸å¿ƒ APIï¼ˆLucene æ˜¯ Apache çš„æ¯•ä¸šå¼€æºæœç´¢å¼•æ“ç±»åº“ï¼ŒåŸºäº Java å¼€å‘ï¼‰

Logstash æ˜¯ä¸€ä¸ªæµå¤„ç†å·¥å…·ï¼Œå®ƒæä¾›äº†å¤§é‡æ’ä»¶ï¼Œå¯ç”¨å®ƒè‡ªå·±çš„ [Filter](https://www.elastic.co/guide/en/logstash/current/filter-plugins.html) å¸®åŠ©ä½ è§£æï¼Œä¸°å¯Œï¼Œè½¬æ¢å’Œç¼“å†²æ¥è‡ªå„ç§æ¥æºçš„æ•°æ®ï¼Œæœ€åï¼Œå®ƒå¯ä»¥æŠŠè‡ªå·±çš„æ•°æ®è¾“å‡ºåˆ°å„ç§éœ€è¦çš„æ•°æ®å‚¨å­˜åœ°ï¼Œè¿™å…¶ä¸­åŒ…æ‹¬ Elasticsearch

- å®‰æ’è¿™ç±»å®‰å…¨ç±»çš„å…¬å¸åšå¼€å‘ä¼¼ä¹ç”¨çš„æ¯”è¾ƒå¤š

ç›¸æ¯”äº Luceneï¼ŒElasticSearch å…·å¤‡ä¸‹åˆ—ä¼˜ç‚¹

1. æ”¯æŒåˆ†å¸ƒå¼ï¼Œå¯æ°´å¹³æ‰©å±•
2. æä¾› Restful æ¥å£ï¼Œå¯é€šè¿‡ä»»æ„è¯­è¨€ä»¥ HTTP æ–¹å¼è°ƒç”¨

ES çš„æ ¸å¿ƒåœ¨äºå€’æ’ç´¢å¼•ï¼ˆç›¸å¯¹äºå…³ç³»å‹æ•°æ®åº“çš„æ­£å‘ç´¢å¼•è€Œè¨€ï¼‰ï¼Œåœ¨æ¨¡ç³Šæœç´¢æ—¶é€Ÿåº¦å¾ˆå¿«ï¼ˆä¾ä»—äº BM25 ç®—æ³•ï¼‰

ES çš„æ ¸å¿ƒè¯„åˆ†ç®—æ³•ï¼šä¸€å¼€å§‹æ˜¯ TF-IDF ç®—æ³•

<img src="./assets/2729274-20230205173433826-368331600.png">

åæ¥æ˜¯ BM25 ç®—æ³•ï¼ˆåœ¨ 5.1 ç‰ˆæœ¬åï¼‰ï¼Œæ²¡é”™ï¼Œå°±æ˜¯è¿™ç¯‡ç”¨åˆ°çš„ - [åŸºäº BM25 ç®—æ³•çš„å¯æœç´¢åŠ å¯†ç³»ç»Ÿ | Arkrypto Wiki](https://northboat.github.io/pages/7bc025/#jpbc-åŸºç¡€)

<img src="./assets/2729274-20230205173438720-1124832591.png">

ä¸ MySQL çš„å¯¹æ¯”

| **MySQL** | **Elasticsearch** | **è¯´æ˜**                                                     |
| --------- | ----------------- | ------------------------------------------------------------ |
| Table     | Index             | ç´¢å¼•ï¼ˆindexï¼‰ï¼Œå°±æ˜¯æ–‡æ¡£çš„é›†åˆï¼Œç±»ä¼¼æ•°æ®åº“çš„è¡¨(table)         |
| Row       | Document          | æ–‡æ¡£ï¼ˆDocumentï¼‰ï¼Œå°±æ˜¯ä¸€æ¡æ¡çš„æ•°æ®ï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„è¡Œï¼ˆRowï¼‰ï¼Œæ–‡æ¡£éƒ½æ˜¯ JSON æ ¼å¼ |
| Column    | Field             | å­—æ®µï¼ˆFieldï¼‰ï¼Œå°±æ˜¯ JSON æ–‡æ¡£ä¸­çš„å­—æ®µï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„åˆ—ï¼ˆColumnï¼‰ |
| Schema    | Mapping           | Mappingï¼ˆæ˜ å°„ï¼‰æ˜¯ç´¢å¼•ä¸­æ–‡æ¡£çš„çº¦æŸï¼Œä¾‹å¦‚å­—æ®µç±»å‹çº¦æŸã€‚ç±»ä¼¼æ•°æ®åº“çš„è¡¨ç»“æ„ï¼ˆSchemaï¼‰ |
| SQL       | DSL               | DSL æ˜¯ elasticsearch æä¾›çš„JSONé£æ ¼çš„è¯·æ±‚è¯­å¥ï¼Œç”¨æ¥æ“ä½œ elasticsearchï¼Œå®ç°CRUD |

åƒæ“çºµ MySQL ä¸€æ ·ï¼Œæˆ‘ä»¬æœ¬è´¨ä¸Šéƒ½æ˜¯ä½¿ç”¨ DSL å¯¹ ES è¿›è¡Œ CRUDï¼Œæ— è®ºæ˜¯å‘½ä»¤è¡Œè¿˜æ˜¯è°ƒç”¨ RestAPIï¼Œéƒ½æ˜¯åœ¨å®Œæˆè¿™ä¸€å·¥ä½œ

### DSL

ç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“çš„ SQLï¼Œé‡‡ç”¨æ›´ä¸ºç®€å•çš„ Json æ ¼å¼

1ï¸âƒ£ POST å‘½ä»¤æ–°å¢æ–‡æ¡£ï¼Œå…¨éƒ¨æ˜¯é”®å€¼å¯¹çš„å½¢å¼è¿›è¡Œæ·»åŠ 

```json
POSTÂ /northboat/_doc/1
{
Â Â Â Â "info":Â "çœŸç›¸åªæœ‰ä¸€ä¸ªï¼",
Â Â Â Â "email":Â "zy@itcast.cn",
Â Â Â Â "name":Â {
Â Â Â Â Â Â Â Â "firstName":Â "æŸ¯",
Â Â Â Â Â Â Â Â "lastName":Â "å—"
Â Â Â Â }
}
```

2ï¸âƒ£ GET æŸ¥è¯¢æ–‡æ¡£

```json
GET /northboat/_doc/1
```

3ï¸âƒ£ DELETE åˆ é™¤æ–‡æ¡£

```json
# æ ¹æ®idåˆ é™¤æ•°æ®
DELETE /northboat/_doc/1
```

4ï¸âƒ£ PUT å…¨é‡ä¿®æ”¹æ–‡æ¡£ï¼ˆè¦†ç›–ä¿®æ”¹ï¼‰ï¼Œå®é™…ä¸Šæ˜¯å…ˆé€šè¿‡ id DELETE æ‰åŸæœ‰æ–‡æ¡£ï¼Œå† POST ä¸€ä¸ªç›¸åŒ id çš„æ–‡æ¡£

```json
PUTÂ /northboat/_doc/1
{
Â Â Â Â "info":Â "è¥¿ç”µå‡¯Ã·CIAå®éªŒå®¤",
Â Â Â Â "email":Â "zy@itcast.cn",
Â Â Â Â "name":Â {
Â Â Â Â Â Â Â Â "firstName":Â "äº‘",
Â Â Â Â Â Â Â Â "lastName":Â "èµµ"
Â Â Â Â }
}
```

5ï¸âƒ£ POST å¢é‡ä¿®æ”¹ï¼Œåªä¿®æ”¹æŒ‡å®š id åŒ¹é…çš„æ–‡æ¡£ä¸­çš„**éƒ¨åˆ†å­—æ®µ**

```json
POSTÂ /northboat/_doc/1
{
Â Â Â Â "doc": {
         "email":Â "northboat@163.com",
    }
}
```

### ç´¢å¼•åº“

åœ¨ç°å®åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¸å¯èƒ½å»æ‰‹åŠ¨åˆ›å»ºç´¢å¼•åº“ï¼Œåº”è¯¥æ˜¯æ ¹æ®æ¯ä¸ªæ–‡æ¡£çš„**å…³é”®è¯**å»åˆ›å»ºå¯¹åº”çš„ jsonï¼Œé‚£ä¹ˆè¿™ä¸€è¿‡ç¨‹ä¸€å®šæ˜¯éœ€è¦ç”¨åˆ°**åˆ†è¯å™¨**å¯¹æ•´ä¸ªæ–‡æ¡£è¿›è¡Œå…³é”®è¯çš„åˆ†å‰²

æˆ‘ä»¬è¯´ï¼Œåˆ›å»ºç´¢å¼•åº“ï¼Œæœ€å…³é”®çš„æ˜¯ mapping æ˜ å°„ï¼ˆæ„å»º json æ˜ å°„å…³ç³»ï¼‰ï¼Œè€Œ mapping æ˜ å°„è¦è€ƒè™‘çš„ä¿¡æ¯åŒ…æ‹¬ï¼š

- å­—æ®µå
- å­—æ®µæ•°æ®ç±»å‹
- æ˜¯å¦å‚ä¸æœç´¢
- æ˜¯å¦éœ€è¦åˆ†è¯
- å¦‚æœåˆ†è¯ï¼Œåˆ†è¯å™¨æ˜¯ä»€ä¹ˆ

åœ¨è®¾è®¡æ—¶

1. ä¾ç…§å…³ç³»å‹æ•°æ®åº“çš„å­—æ®µè®¾è®¡æ–¹å¼è¿›è¡Œè®¾è®¡
2. æˆ‘ä»¬åªå¯¹éœ€è¦è¿›è¡Œæœç´¢çš„å­—æ®µè¿›è¡Œæ˜ å°„ï¼Œæ¯”å¦‚ä¸»é”®è‚¯å®šéœ€è¦ï¼Œè€Œå›¾ç‰‡åœ°å€å°±æ— éœ€å‚ä¸
3. åˆ†è¯å™¨æ–¹é¢ï¼Œå¯ä»¥ç»Ÿä¸€ä½¿ç”¨ IK_MAX_WORD

ä¸€ä¸ª Hotel é…’åº—ç´¢å¼•åº“ç¤ºä¾‹ï¼Œé€šè¿‡ PUT å‘½ä»¤åˆ›å»º

```json
PUT /hotel
{
  "mappings": {
    "properties": {
      "id": {
        "type": "keyword"
      },
      "name":{
        "type": "text",
        "analyzer": "ik_max_word",
        "copy_to": "all"
      },
      "address":{
        "type": "keyword",
        "index": false
      },
      "price":{
        "type": "integer"
      },
      "score":{
        "type": "integer"
      },
      "brand":{
        "type": "keyword",
        "copy_to": "all"
      },
      "city":{
        "type": "keyword",
        "copy_to": "all"
      },
      "starName":{
        "type": "keyword"
      },
      "business":{
        "type": "keyword"
      },
      "location":{
        "type": "geo_point"
      },
      "pic":{
        "type": "keyword",
        "index": false
      },
      "all":{
        "type": "text",
        "analyzer": "ik_max_word"
      }
    }
  }
}
```

å‡ ä¸ªç‰¹æ®Šå­—æ®µè¯´æ˜

- locationï¼šåœ°ç†åæ ‡ï¼Œé‡Œé¢åŒ…å«ç²¾åº¦ã€çº¬åº¦
- allï¼šä¸€ä¸ªç»„åˆå­—æ®µï¼Œå…¶ç›®çš„æ˜¯å°†å¤šå­—æ®µçš„å€¼ åˆ©ç”¨copy_toåˆå¹¶ï¼Œæä¾›ç»™ç”¨æˆ·æœç´¢

location åœ°ç†åæ ‡

<img src="./assets/2729274-20230205172124085-626335563.png">

copy_to å±æ€§ï¼šå°†å½“å‰å­—æ®µæ‹·è´åˆ°æŒ‡å®šå­—æ®µ

<img src="./assets/2729274-20230205172128097-289087887.png">

å½“ç„¶äº†ï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ Java API æ¥æ“ä½œ ES æ•°æ®åº“ï¼š[Elasticsearch Clients | Elastic](https://www.elastic.co/guide/en/elasticsearch/client/index.html)

å¼•å…¥ Java HighLevel Rest Clientä¾èµ–

```xml
<dependency>
    <groupId>org.elasticsearch.client</groupId>
    <artifactId>elasticsearch-rest-high-level-client</artifactId>
</dependency>
```

å› ä¸º SpringBoot é»˜è®¤çš„ ES ç‰ˆæœ¬æ˜¯ 7.6.2ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¦†ç›–é»˜è®¤çš„ ES ç‰ˆæœ¬ä¸è‡ªå·±çš„ç‰ˆæœ¬ä¸€è‡´

```xml
<properties>
    <java.version>1.8</java.version>
    <elasticsearch.version>7.12.1</elasticsearch.version>
</properties>
```

åˆå§‹åŒ– RestHighLevelClient å¹¶æ³¨å…¥ Bean

```java
@Bean
public RestHighLevelClient client(){
    return new RestHighLevelClient(RestClient.builder(
        HttpHost.create("http://192.168.150.101:9200")
	));
}
```

è¿™é‡Œä¸ºäº†å•å…ƒæµ‹è¯•æ–¹ä¾¿ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±» HotelIndexTestï¼Œç„¶åå°†åˆå§‹åŒ–çš„ä»£ç ç¼–å†™åœ¨ @BeforeEach æ–¹æ³•ä¸­

```java
package cn.itcast.hotel;

import org.apache.http.HttpHost;
import org.elasticsearch.client.RestHighLevelClient;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.io.IOException;

public class HotelIndexTest {
    private RestHighLevelClient client;

    @BeforeEach
    void setUp() {
        this.client = new RestHighLevelClient(RestClient.builder(
                HttpHost.create("http://192.168.150.101:9200")
        ));
    }

    @AfterEach
    void tearDown() throws IOException {
        this.client.close();
    }
}
```

CRUD æ–‡æ¡£åº“ Hotelï¼Œæœ¬è´¨ä¸Šå°±æ˜¯**æ‹¼æ¥å­—ç¬¦ä¸²å’Œ HTTP è¯·æ±‚**ï¼Œå‘ ES æ•°æ®åº“**å‘é€ DSL å‘½ä»¤**ï¼Œè€Œå ES è¿”å›æ‰§è¡Œç»“æœçš„è¿‡ç¨‹

### æ–‡æ¡£

æ–‡æ¡£ä¹‹äºç´¢å¼•åº“ï¼Œå°±åƒæ•°æ®è¡¨ä¹‹äºæ•°æ®åº“ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­ï¼ŒåŸºæœ¬ä¸Šæ˜¯å…ˆè¯»å– MySQL æ•°æ®è¡¨ä¸­çš„æ•°æ®ï¼Œç„¶åå†å­˜è¿› ES çš„æ–‡æ¡£ä¸­

æ–‡æ¡£æ“ä½œçš„åŸºæœ¬æ­¥éª¤ï¼šæ ¹æ®å‘é€è¯·æ±‚é‚£æ­¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå‘è¿‡æ¥åˆ¤æ–­éœ€è¦åˆ›å»ºä»€ä¹ˆ`XXXRequest`

1. åˆå§‹åŒ– RestHighLevelClient
2. åˆ›å»º`XXXRequest`ï¼ŒXXX å¯ä»¥æ˜¯ Indexã€Getã€Updateã€Deleteã€Bulk
3. å‡†å¤‡å‚æ•°ï¼ˆIndexã€Updateã€Bulkæ—¶éœ€è¦ï¼‰
4. å‘é€è¯·æ±‚ï¼šè°ƒç”¨`RestHighLevelClient.xxx()`æ–¹æ³•ï¼Œxxx æ˜¯ indexã€getã€updateã€deleteã€bulk
5. è§£æç»“æœï¼ˆGet æ—¶éœ€è¦ï¼‰

ES çš„æŸ¥è¯¢æ˜¯ä¸€é—¨åŠŸå¤«ï¼Œç±»ä¼¼äº SQL çš„ç¼–å†™ï¼Œå¯ä»¥æœ‰å¾ˆå¤šæŸ¥è¯¢æ¡ä»¶å’Œå¤åˆåµŒå¥—è§„åˆ™

