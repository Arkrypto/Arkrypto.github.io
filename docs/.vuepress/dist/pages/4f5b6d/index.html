<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>分布式系统设计（二） | Arkrypto&#39;s Wiki</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3129839_xft6cqs5gc.css">
    <noscript><meta http-equiv="refresh" content="0; url=https://www.youngkbt.cn/noscript/"><style>.theme-vdoing-content { display:none }</noscript>
    <meta name="description" content="My Wiki">
    <meta name="keywords" content="Arkrypto, ComputerScience, DevOps, Crypto">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.9d35511c.css" as="style"><link rel="preload" href="/assets/js/app.f341c693.js" as="script"><link rel="preload" href="/assets/js/3.65b33734.js" as="script"><link rel="preload" href="/assets/js/34.24f5e7a5.js" as="script"><link rel="preload" href="/assets/js/39.97abe7b7.js" as="script"><link rel="prefetch" href="/assets/js/10.dc21ab75.js"><link rel="prefetch" href="/assets/js/100.a001bd77.js"><link rel="prefetch" href="/assets/js/101.b6b6b840.js"><link rel="prefetch" href="/assets/js/102.f28c5678.js"><link rel="prefetch" href="/assets/js/103.7ad21204.js"><link rel="prefetch" href="/assets/js/104.91ef96bd.js"><link rel="prefetch" href="/assets/js/105.7f7edf7d.js"><link rel="prefetch" href="/assets/js/106.fc3cef07.js"><link rel="prefetch" href="/assets/js/107.de279a4f.js"><link rel="prefetch" href="/assets/js/108.d6798e24.js"><link rel="prefetch" href="/assets/js/109.5a7b96da.js"><link rel="prefetch" href="/assets/js/11.920a5eb8.js"><link rel="prefetch" href="/assets/js/110.5b27f011.js"><link rel="prefetch" href="/assets/js/111.620ec8e5.js"><link rel="prefetch" href="/assets/js/112.2a40e4d9.js"><link rel="prefetch" href="/assets/js/113.5ec9717c.js"><link rel="prefetch" href="/assets/js/114.c15073e9.js"><link rel="prefetch" href="/assets/js/115.115c29d5.js"><link rel="prefetch" href="/assets/js/116.4c0dd9f6.js"><link rel="prefetch" href="/assets/js/117.1dc9bba2.js"><link rel="prefetch" href="/assets/js/118.21cb1e08.js"><link rel="prefetch" href="/assets/js/119.cd69ba6c.js"><link rel="prefetch" href="/assets/js/12.06868f8a.js"><link rel="prefetch" href="/assets/js/120.a7a99ec8.js"><link rel="prefetch" href="/assets/js/121.07d92cfa.js"><link rel="prefetch" href="/assets/js/122.69e91a10.js"><link rel="prefetch" href="/assets/js/123.6cfd071d.js"><link rel="prefetch" href="/assets/js/124.65ca20dd.js"><link rel="prefetch" href="/assets/js/125.69c2e7ce.js"><link rel="prefetch" href="/assets/js/126.c46e0e41.js"><link rel="prefetch" href="/assets/js/127.c79d9831.js"><link rel="prefetch" href="/assets/js/128.024fa568.js"><link rel="prefetch" href="/assets/js/129.d4f24126.js"><link rel="prefetch" href="/assets/js/13.94fa2172.js"><link rel="prefetch" href="/assets/js/130.585e1f1b.js"><link rel="prefetch" href="/assets/js/131.79b08e75.js"><link rel="prefetch" href="/assets/js/132.3755363f.js"><link rel="prefetch" href="/assets/js/133.e18a4311.js"><link rel="prefetch" href="/assets/js/134.78afadae.js"><link rel="prefetch" href="/assets/js/135.e7b6d5e3.js"><link rel="prefetch" href="/assets/js/136.d910d00a.js"><link rel="prefetch" href="/assets/js/137.3e771a38.js"><link rel="prefetch" href="/assets/js/138.63ee9634.js"><link rel="prefetch" href="/assets/js/139.d7aa896f.js"><link rel="prefetch" href="/assets/js/14.7a4b88c5.js"><link rel="prefetch" href="/assets/js/140.7591b743.js"><link rel="prefetch" href="/assets/js/141.f4092ccf.js"><link rel="prefetch" href="/assets/js/142.aea9e70e.js"><link rel="prefetch" href="/assets/js/143.7d9663f5.js"><link rel="prefetch" href="/assets/js/144.2a3983a7.js"><link rel="prefetch" href="/assets/js/145.7c011f9b.js"><link rel="prefetch" href="/assets/js/146.89456235.js"><link rel="prefetch" href="/assets/js/147.a2cf48e9.js"><link rel="prefetch" href="/assets/js/148.1623b901.js"><link rel="prefetch" href="/assets/js/149.81494a04.js"><link rel="prefetch" href="/assets/js/15.0676fa28.js"><link rel="prefetch" href="/assets/js/150.3546d4ba.js"><link rel="prefetch" href="/assets/js/151.9d174105.js"><link rel="prefetch" href="/assets/js/152.226fc03c.js"><link rel="prefetch" href="/assets/js/153.3c573325.js"><link rel="prefetch" href="/assets/js/154.277cbc80.js"><link rel="prefetch" href="/assets/js/155.a6e047e0.js"><link rel="prefetch" href="/assets/js/156.5bc575c2.js"><link rel="prefetch" href="/assets/js/157.30b8c53c.js"><link rel="prefetch" href="/assets/js/158.89b5b632.js"><link rel="prefetch" href="/assets/js/159.2e775a4e.js"><link rel="prefetch" href="/assets/js/16.be91a8ac.js"><link rel="prefetch" href="/assets/js/160.0074f45e.js"><link rel="prefetch" href="/assets/js/161.7f963ca3.js"><link rel="prefetch" href="/assets/js/162.17c03f0c.js"><link rel="prefetch" href="/assets/js/163.49129834.js"><link rel="prefetch" href="/assets/js/164.cd0b4fa6.js"><link rel="prefetch" href="/assets/js/165.e978bc36.js"><link rel="prefetch" href="/assets/js/166.c6605980.js"><link rel="prefetch" href="/assets/js/167.0e80e68c.js"><link rel="prefetch" href="/assets/js/168.7c738645.js"><link rel="prefetch" href="/assets/js/169.92d1d10c.js"><link rel="prefetch" href="/assets/js/17.bbdc430d.js"><link rel="prefetch" href="/assets/js/170.66a22b81.js"><link rel="prefetch" href="/assets/js/171.19a33354.js"><link rel="prefetch" href="/assets/js/172.b9541591.js"><link rel="prefetch" href="/assets/js/173.7ca9e075.js"><link rel="prefetch" href="/assets/js/174.7ba0333f.js"><link rel="prefetch" href="/assets/js/175.0a73ccad.js"><link rel="prefetch" href="/assets/js/176.f837666b.js"><link rel="prefetch" href="/assets/js/177.25468dc3.js"><link rel="prefetch" href="/assets/js/178.5361bf61.js"><link rel="prefetch" href="/assets/js/179.2e8a2de3.js"><link rel="prefetch" href="/assets/js/18.09fb0d29.js"><link rel="prefetch" href="/assets/js/180.2e98bb39.js"><link rel="prefetch" href="/assets/js/181.1767456c.js"><link rel="prefetch" href="/assets/js/182.f7f20c0b.js"><link rel="prefetch" href="/assets/js/183.d2501980.js"><link rel="prefetch" href="/assets/js/184.6cb58a4f.js"><link rel="prefetch" href="/assets/js/185.261d9935.js"><link rel="prefetch" href="/assets/js/186.dffc4267.js"><link rel="prefetch" href="/assets/js/187.bef5f311.js"><link rel="prefetch" href="/assets/js/188.7a1e326e.js"><link rel="prefetch" href="/assets/js/189.aab67582.js"><link rel="prefetch" href="/assets/js/19.ecb334d1.js"><link rel="prefetch" href="/assets/js/190.97130b8c.js"><link rel="prefetch" href="/assets/js/191.3a9e8878.js"><link rel="prefetch" href="/assets/js/192.98180778.js"><link rel="prefetch" href="/assets/js/193.25cfc985.js"><link rel="prefetch" href="/assets/js/194.e07db9b9.js"><link rel="prefetch" href="/assets/js/195.bf53d6fc.js"><link rel="prefetch" href="/assets/js/196.01eeea0c.js"><link rel="prefetch" href="/assets/js/197.5de0ee18.js"><link rel="prefetch" href="/assets/js/198.16c7674c.js"><link rel="prefetch" href="/assets/js/199.84d39d79.js"><link rel="prefetch" href="/assets/js/2.a31c5715.js"><link rel="prefetch" href="/assets/js/20.67c2245b.js"><link rel="prefetch" href="/assets/js/200.92ae0c0c.js"><link rel="prefetch" href="/assets/js/201.31033719.js"><link rel="prefetch" href="/assets/js/202.197833ef.js"><link rel="prefetch" href="/assets/js/203.d8b18a3d.js"><link rel="prefetch" href="/assets/js/204.aef37302.js"><link rel="prefetch" href="/assets/js/21.82900010.js"><link rel="prefetch" href="/assets/js/22.9360f260.js"><link rel="prefetch" href="/assets/js/23.cad3a95c.js"><link rel="prefetch" href="/assets/js/24.57285a45.js"><link rel="prefetch" href="/assets/js/25.aec3252f.js"><link rel="prefetch" href="/assets/js/26.b73f1ecd.js"><link rel="prefetch" href="/assets/js/27.67222f75.js"><link rel="prefetch" href="/assets/js/28.ebbe8713.js"><link rel="prefetch" href="/assets/js/29.06945c62.js"><link rel="prefetch" href="/assets/js/30.175a82b0.js"><link rel="prefetch" href="/assets/js/31.b6d7ee47.js"><link rel="prefetch" href="/assets/js/32.da20705f.js"><link rel="prefetch" href="/assets/js/33.1878b489.js"><link rel="prefetch" href="/assets/js/35.9a145851.js"><link rel="prefetch" href="/assets/js/36.12438e7b.js"><link rel="prefetch" href="/assets/js/37.59262741.js"><link rel="prefetch" href="/assets/js/38.772459e5.js"><link rel="prefetch" href="/assets/js/4.bbc08de3.js"><link rel="prefetch" href="/assets/js/40.d174eac9.js"><link rel="prefetch" href="/assets/js/41.4cfadc41.js"><link rel="prefetch" href="/assets/js/42.e3387142.js"><link rel="prefetch" href="/assets/js/43.db46e959.js"><link rel="prefetch" href="/assets/js/44.97919f0f.js"><link rel="prefetch" href="/assets/js/45.f8da89cd.js"><link rel="prefetch" href="/assets/js/46.984c7f39.js"><link rel="prefetch" href="/assets/js/47.e59ee5ca.js"><link rel="prefetch" href="/assets/js/48.054ae7b9.js"><link rel="prefetch" href="/assets/js/49.4922209a.js"><link rel="prefetch" href="/assets/js/5.1f6d3ede.js"><link rel="prefetch" href="/assets/js/50.fcf17677.js"><link rel="prefetch" href="/assets/js/51.d46b5103.js"><link rel="prefetch" href="/assets/js/52.c0797375.js"><link rel="prefetch" href="/assets/js/53.9cdbd6e0.js"><link rel="prefetch" href="/assets/js/54.67bb6b55.js"><link rel="prefetch" href="/assets/js/55.9b8dfbfe.js"><link rel="prefetch" href="/assets/js/56.b38f1930.js"><link rel="prefetch" href="/assets/js/57.5f33e67a.js"><link rel="prefetch" href="/assets/js/58.866fdb02.js"><link rel="prefetch" href="/assets/js/59.31c09cf2.js"><link rel="prefetch" href="/assets/js/6.4de57d7d.js"><link rel="prefetch" href="/assets/js/60.4e9407f3.js"><link rel="prefetch" href="/assets/js/61.0b392571.js"><link rel="prefetch" href="/assets/js/62.ec1f452c.js"><link rel="prefetch" href="/assets/js/63.8d073a72.js"><link rel="prefetch" href="/assets/js/64.043424c8.js"><link rel="prefetch" href="/assets/js/65.c5aede8f.js"><link rel="prefetch" href="/assets/js/66.7d6d3329.js"><link rel="prefetch" href="/assets/js/67.3a12aa07.js"><link rel="prefetch" href="/assets/js/68.41f7aa38.js"><link rel="prefetch" href="/assets/js/69.4d7a983f.js"><link rel="prefetch" href="/assets/js/7.77c503e7.js"><link rel="prefetch" href="/assets/js/70.a3b93f4d.js"><link rel="prefetch" href="/assets/js/71.63e1d8e5.js"><link rel="prefetch" href="/assets/js/72.214c2d50.js"><link rel="prefetch" href="/assets/js/73.36e9a6c0.js"><link rel="prefetch" href="/assets/js/74.238c496b.js"><link rel="prefetch" href="/assets/js/75.1049cc2d.js"><link rel="prefetch" href="/assets/js/76.d5dc4dd5.js"><link rel="prefetch" href="/assets/js/77.8f5552e9.js"><link rel="prefetch" href="/assets/js/78.e78cbc80.js"><link rel="prefetch" href="/assets/js/79.36834811.js"><link rel="prefetch" href="/assets/js/8.b15510d5.js"><link rel="prefetch" href="/assets/js/80.695d4109.js"><link rel="prefetch" href="/assets/js/81.e2b3787e.js"><link rel="prefetch" href="/assets/js/82.fa40a106.js"><link rel="prefetch" href="/assets/js/83.6ffc7807.js"><link rel="prefetch" href="/assets/js/84.79eea17e.js"><link rel="prefetch" href="/assets/js/85.de1bbfac.js"><link rel="prefetch" href="/assets/js/86.3cf15d60.js"><link rel="prefetch" href="/assets/js/87.af6ab036.js"><link rel="prefetch" href="/assets/js/88.706f9431.js"><link rel="prefetch" href="/assets/js/89.802917ef.js"><link rel="prefetch" href="/assets/js/9.467e9341.js"><link rel="prefetch" href="/assets/js/90.28ba2e91.js"><link rel="prefetch" href="/assets/js/91.62334efc.js"><link rel="prefetch" href="/assets/js/92.54c04caf.js"><link rel="prefetch" href="/assets/js/93.ef4951b2.js"><link rel="prefetch" href="/assets/js/94.8b71e209.js"><link rel="prefetch" href="/assets/js/95.b73c8f04.js"><link rel="prefetch" href="/assets/js/96.5579503a.js"><link rel="prefetch" href="/assets/js/97.42da9c37.js"><link rel="prefetch" href="/assets/js/98.4854e694.js"><link rel="prefetch" href="/assets/js/99.25b6bf06.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9d35511c.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Arkrypto's Wiki" class="logo"> <span class="site-name can-hide">Arkrypto's Wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/cs/" class="nav-link">计算机科学与技术</a></div><div class="nav-item"><a href="/dev/" class="nav-link">开发与运维</a></div><div class="nav-item"><a href="/sec/" class="nav-link">网络与信息安全</a></div><div class="nav-item"><a href="/mine/" class="nav-link">我的</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div> <a href="https://github.com/Arkrypto" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.gif"> <div class="blogger-info"><h3>Arkrypto</h3> <span>就在坚冰还盖着北海的时候，我看到了怒放的梅花</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/cs/" class="nav-link">计算机科学与技术</a></div><div class="nav-item"><a href="/dev/" class="nav-link">开发与运维</a></div><div class="nav-item"><a href="/sec/" class="nav-link">网络与信息安全</a></div><div class="nav-item"><a href="/mine/" class="nav-link">我的</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div> <a href="https://github.com/Arkrypto" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>后端开发</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Java SE 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Java Web 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>JUC 并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>微服务与分布式</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/9e801d/" class="sidebar-link">软件工程原理与应用</a></li><li><a href="/pages/2d1368/" class="sidebar-link">Spring 基础</a></li><li><a href="/pages/095bba/" class="sidebar-link">Spring 生态</a></li><li><a href="/pages/9a8ad9/" class="sidebar-link">分布式系统设计（一）</a></li><li><a href="/pages/4f5b6d/" aria-current="page" class="active sidebar-link">分布式系统设计（二）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/4f5b6d/#消息队列-mq" class="sidebar-link">消息队列 MQ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#消息队列模型" class="sidebar-link">消息队列模型</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#rabbitmq" class="sidebar-link">RabbitMQ</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#确保可靠传输" class="sidebar-link">确保可靠传输</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#消息队列的选择" class="sidebar-link">消息队列的选择</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4f5b6d/#大数据计算" class="sidebar-link">大数据计算</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#flink" class="sidebar-link">Flink</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#spark" class="sidebar-link">Spark</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4f5b6d/#elastic-栈" class="sidebar-link">Elastic 栈</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#elk" class="sidebar-link">ELK</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#dsl" class="sidebar-link">DSL</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#索引库设计" class="sidebar-link">索引库设计</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#索引库-crud" class="sidebar-link">索引库 CRUD</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#文档-crud" class="sidebar-link">文档 CRUD</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#logstash" class="sidebar-link">Logstash</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4f5b6d/#常见分布式问题" class="sidebar-link">常见分布式问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#分布式事务" class="sidebar-link">分布式事务</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#分布式锁" class="sidebar-link">分布式锁</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#分布式会话" class="sidebar-link">分布式会话</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#分布式-id" class="sidebar-link">分布式 ID</a></li><li class="sidebar-sub-header level3"><a href="/pages/4f5b6d/#分布式链路追踪" class="sidebar-link">分布式链路追踪</a></li></ul></li></ul></li><li><a href="/pages/2afee4/" class="sidebar-link">分布式系统设计（三）</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>秽土转生 Go</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端开发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>运维</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/dev/#开发与运维" data-v-06970110>开发与运维</a></li><li data-v-06970110><a href="/dev/#后端开发" data-v-06970110>后端开发</a></li><li data-v-06970110><a href="/dev/#微服务与分布式" data-v-06970110>微服务与分布式</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/Arkrypto" target="_blank" title="作者" class="beLink" data-v-06970110>Arkrypto</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-21</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">分布式系统设计（二）<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="消息队列-mq"><a href="#消息队列-mq" class="header-anchor">#</a> 消息队列 MQ</h2> <h3 id="消息队列模型"><a href="#消息队列模型" class="header-anchor">#</a> 消息队列模型</h3> <p>队列模型，又叫点对点模型，每个生产者对应一个消费者（一对一）</p> <ul><li>比如 OJ 中 MQ 的使用，后端收到判题请求后，先将判题记录写入数据库，而后作为生产者将判题记录 ID 写入消息队列，此时真正的判题模块由于订阅了该判题队列，于是自动从 MQ 中读出判题请求 ID，从 DB 中拿取数据执行判题业务，最后通过 WebSocket 返回</li></ul> <p>订阅发布模型，一个生产者将把消息广播到每一个订阅者，即一对多</p> <p>订阅发布能够将串行执行的任务变成“并行”，例如以下串行场景，他是一步步执行</p> <img src="/assets/img/image-20250303143017426.77128625.png"> <p>若引入 MQ，它可以变成这样的形式，这是合理的，实际上，更新积分、通知商家、更新用户标签这三个事件并没有直接的逻辑联系或是执行顺序问题，他们都是由“更新订单状态触发”</p> <img src="/assets/img/image-20250303143143342.6d217d1f.png"> <p>从而大幅提高效率</p> <p>上述订阅发布模式的举例是 MQ 一大应用场景，<strong>异步处理</strong>，而队列模式的举例是<strong>应用解耦</strong>，消息队列的常用场景如下</p> <ul><li>异步处理：就是将一些非核心的业务流程以异步并行的方式执行，从而减少请求响应时间，提高系统吞吐量</li> <li>应用解耦：顾名思义就是解除应用系统之间的耦合依赖。通过消息队列，使得每个应用系统不必受其他系统影响，可以更独立自主运行</li> <li>流量削峰：是消息队列中的常用场景，一般在秒杀或团抢活动中使用广泛</li> <li>消息通讯：指应用间的数据通信，消息队列一般都内置了高效的通信机制，因此也可以用在纯的消息通讯。比如实现点对点消息队列，或者聊天室等点对点通讯</li></ul> <h3 id="rabbitmq"><a href="#rabbitmq" class="header-anchor">#</a> RabbitMQ</h3> <p>现有一些开源 MQ 的对比</p> <table><thead><tr><th>特性\消息队列</th> <th>Kafka</th> <th>RocketMQ</th> <th>RabbitMQ</th> <th>ActiveMQ</th></tr></thead> <tbody><tr><td>单机吞吐量</td> <td>10万级</td> <td>10万级</td> <td>万级</td> <td>10万级</td></tr> <tr><td>开发语言</td> <td>Scala</td> <td>Java</td> <td>Erlang</td> <td>Java</td></tr> <tr><td>高可用</td> <td>分布式</td> <td>分布式</td> <td>主从</td> <td>分布式</td></tr> <tr><td>消息延迟</td> <td>ms级</td> <td>ms级</td> <td>us级</td> <td>ms级</td></tr> <tr><td>消息丢失</td> <td>理论上不会丢失</td> <td>理论上不会丢失</td> <td>低</td> <td>低</td></tr> <tr><td>消费模式</td> <td>拉取</td> <td>推拉</td> <td>推拉</td> <td></td></tr> <tr><td>持久化</td> <td></td> <td>文件</td> <td>内存，文件</td> <td>内存，文件，数据库</td></tr> <tr><td>支持协议</td> <td>自定义协议</td> <td>自定义协议</td> <td>AMQP，XMPP, SMTP,STOMP</td> <td>AMQP,MQTT,OpenWire,STOMP</td></tr> <tr><td>社区活跃度</td> <td>高</td> <td>中</td> <td>高</td> <td>高</td></tr> <tr><td>管理界面</td> <td></td> <td>web console</td> <td>好</td> <td>一般</td></tr> <tr><td>部署难度</td> <td>中</td> <td></td> <td>低</td> <td></td></tr> <tr><td>部署方式</td> <td>独立</td> <td>独立</td> <td>独立</td> <td>独立，嵌入</td></tr> <tr><td>成熟度</td> <td>成熟</td> <td>比较成熟</td> <td>成熟</td> <td>成熟</td></tr> <tr><td>综合评价</td> <td>优点：拥有强大的性能及吞吐量，兼容性很好。 缺点：由于支持消息堆积，导致延迟比较高</td> <td>优点：性能好，稳定可靠，有活跃的中文社区，特点响应快。 缺点：兼容性较差，但随着影响力的扩大，该问题会有改善</td> <td>优点：产品成熟，容易部署和使用，拥有灵活的路由配置。 缺点：性能和吞吐量较差，不易进行二次开发</td> <td>优点：产品成熟，支持协议多，支持多种语言的客户端。 缺点：社区不活跃，存在消息丢失的可能</td></tr></tbody></table> <p>引入 RabbitMQ 依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>配置文件</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
		<span class="token key atrule">host</span><span class="token punctuation">:</span> 10.2.1.231
		<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
		<span class="token key atrule">username</span><span class="token punctuation">:</span> northboat
		<span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
		<span class="token key atrule">virtualHost</span><span class="token punctuation">:</span> order
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>一个简单的消费者，订阅队列&quot;<code>rabbitmq_queue&quot;</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@RabbitHandler</span>
	<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queuesToDeclare <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span><span class="token string">&quot;rabbitmq_queue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者消费消息: &quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>一个简单的生产者</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;Beijing&quot;</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;生产者产生消息: &quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
		rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;rabbitmq_queue&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里传输的是简单字符串，我们尝试传输一个实体对象 User，需要进行序列化，即继承<code>Serializable</code>类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
	<span class="token comment">// 省略get和set方法</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>仍然通过<code>convertAndSend</code>方法进行传输</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	
		<span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;nmsl&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wdnmd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;生产者生产消息: &quot;</span> <span class="token operator">+</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;rabbitmq_queue_object&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>convertAndSend() 方法支持 String、Integer、Object 等基础的数据类型</p> <h3 id="确保可靠传输"><a href="#确保可靠传输" class="header-anchor">#</a> 确保可靠传输</h3> <p>在使用消息队列时，因为生产者和消费者不直接交互，所以面临下面几个问题</p> <ol><li>要把消息添加到队列中，怎么保证消息成功添加？</li> <li>如何保证消息发送出去时一定会被消费者正常消费？</li> <li>消费者正常消费了，生产者或者队列如何知道消费者已经成功消费了消息？</li></ol> <p>那么，如何保证消息 100% 可靠性发送？我们可以采用 ack 应答 + 日志记录 + 定时任务来实现</p> <p>假设有一个创建订单业务，后端收到请求后，将该业务通过消息队列发送到具体的业务模块，我们这样保证消息的可靠传输</p> <ol><li>完成订单业务处理后，生产者发送一条消息到消息队列，同时记录这条操作日志（发送中）</li> <li>消费者收到消息后处理进行</li> <li>消费者处理成功后给消息队列发送 ack 应答</li> <li>消息队列收到 ack 应答后，给生成者的 Confirm Listener 发送确认</li> <li>生产者对消息日志表进行操作，修改之前的日志状态（发送成功）</li> <li>在消费端返回应答的过程中，可能发生网络异常，导致生产者未收到应答消息，因此需要一个定时任务去提取其状态为“发送中”并已经超时的消息集合</li> <li>使用定时任务判断为消息事先设置的最大重发次数，大于最大重发次数就判断消息发送失败，更新日志记录状态为发送失败</li></ol> <p>流程图如下</p> <img src="data:image/png;base64,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"> <p>具体实现</p> <p>1️⃣ 创建生产者</p> <p>定义应答方法<code>final RabbitTemplate.ConfirmCallback confirmCallback = new RabbitTemplate.ConfirmCallback() {}</code>，即定义收到消费者发回的 ack 应答后的处理：更新日志记录，修改订单状态为成功</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitOrderSender</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">RabbitOrderSender</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageLogMapper</span> messageLogMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Broker应答后，会调用该方法区获取应答结果
     */</span>
    <span class="token keyword">final</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span> confirmCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> <span class="token class-name">String</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;correlationData：&quot;</span><span class="token operator">+</span>correlationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> messageId <span class="token operator">=</span> correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息确认返回值：&quot;</span><span class="token operator">+</span>ack<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//如果返回成功，则进行更新</span>
                messageLogMapper<span class="token punctuation">.</span><span class="token function">changeMessageLogStatus</span><span class="token punctuation">(</span>messageId<span class="token punctuation">,</span> <span class="token class-name">Constans</span><span class="token punctuation">.</span><span class="token constant">ORDER_SEND_SUCCESS</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//失败进行操作：根据具体失败原因选择重试或补偿等手段</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;异常处理,返回结果：&quot;</span><span class="token operator">+</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 发送消息方法调用: 构建自定义对象消息
     * @param order
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span>  <span class="token function">sendOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderInfo</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过实现 ConfirmCallback 接口，消息发送到 Broker 后触发回调，确认消息是否到达 Broker 服务器，也就是只确认是否正确到达 Exchange 中</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span>confirmCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息唯一ID</span>
        <span class="token class-name">CorrelationData</span> correlationData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;order.exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;order.message&quot;</span><span class="token punctuation">,</span> order<span class="token punctuation">,</span> correlationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>当生产者调用<code>ConfirmCallback()</code>，说明当前请求已被消费者消费</p> <p>2️⃣ 定义消息定时重发任务</p> <p>定期去数据库中找状态为 0 的数据项，进行消息重发</p> <ul><li>通过<code>@Compoent</code>和<code>@Scheduled(initialDelay = 5000, fixedDelay = 10000)</code>注解将定时任务注入 Spring，初始 5 s 后开始执行，往后每 10s 执行一次</li> <li>判断逻辑为：当重发大于两次，认为任务失败，不再执行，否则通过 RabbitOrderSender 进行重发</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RetryMessageTasker</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">RetryMessageTasker</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitOrderSender</span> rabbitOrderSender<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageLogMapper</span> messageLogMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 定时任务
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>initialDelay <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">,</span> fixedDelay <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;-----------定时任务开始-----------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//抽取消息状态为0且已经超时的消息集合</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageLog</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> messageLogMapper<span class="token punctuation">.</span><span class="token function">query4StatusAndTimeoutMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>messageLog <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//投递三次以上的消息</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>messageLog<span class="token punctuation">.</span><span class="token function">getTryCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//更新失败的消息</span>
                messageLogMapper<span class="token punctuation">.</span><span class="token function">changeMessageLogStatus</span><span class="token punctuation">(</span>messageLog<span class="token punctuation">.</span><span class="token function">getMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constans</span><span class="token punctuation">.</span><span class="token constant">ORDER_SEND_FAILURE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 重试投递消息，将重试次数递增</span>
                messageLogMapper<span class="token punctuation">.</span><span class="token function">update4ReSend</span><span class="token punctuation">(</span>messageLog<span class="token punctuation">.</span><span class="token function">getMessageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">OrderInfo</span> reSendOrder <span class="token operator">=</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token function">jsonToObject</span><span class="token punctuation">(</span>messageLog<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">OrderInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    rabbitOrderSender<span class="token punctuation">.</span><span class="token function">sendOrder</span><span class="token punctuation">(</span>reSendOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;-----------异常处理-----------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>3️⃣ 运行测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqApplicationTests</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 测试订单创建
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">OrderInfo</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">&quot;201901236&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;测试订单6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setMessageId</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;$&quot;</span> <span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            orderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="消息队列的选择"><a href="#消息队列的选择" class="header-anchor">#</a> 消息队列的选择</h3> <p>Kafka 设计之初是用于处理大批量的日志，基于自定义的二进制协议，专注于高吞吐量，其特点如下</p> <p>而 RabbitMQ 的设计目标是<strong>低延迟</strong>和<strong>可靠传递</strong>，它的消息确认机制和重试机制可以确保任务被正确处理，适合高并发的任务，常用于业务的解耦、异步处理</p> <table><thead><tr><th>消息队列</th> <th>协议</th> <th>消息传输</th> <th>实时性</th> <th>扩展性</th> <th>持久化</th></tr></thead> <tbody><tr><td>Kafka</td> <td>基于自定义的二进制协议，专注于高吞吐量</td> <td>消息以<strong>日志</strong>的形式持久化存储，支持高吞吐量的消息流；不支持消息确认（ACK）和重试机制，但可以通过消费者偏移量（Offset）实现消息重放</td> <td>延迟较高，适合批量处理</td> <td>支持分布式集群，可以轻松扩展到数百个节点，处理海量数据</td> <td>消息持久化到磁盘，支持长期存储和回溯</td></tr> <tr><td>RabbitMQ</td> <td>基于 AMQP（Advanced Message Queuing Protocol），支持多种消息模式（如点对点、发布/订阅）</td> <td>支持消息确认（ACK）和重试机制，确保消息可靠传递；支持消息优先级、延迟队列、死信队列等高级特性</td> <td>适合低延迟的消息传递</td> <td>支持复杂的路由规则（如 direct、topic、fanout 等交换器）</td> <td>可以通过集群实现高可用性，但扩展性相对有限</td></tr></tbody></table> <p>什么是 AMQP（Advanced Message Queuing Protocol）</p> <p>RabbitMQ 的适用场景</p> <ul><li>任务队列：适合需要<strong>实时处理</strong>的任务，例如 Web 应用中的异步任务（如发送邮件、处理订单）</li> <li>低延迟场景：需要<strong>快速响应</strong>的场景，例如实时通知、即时消息</li> <li>复杂路由：需要根据消息内容或规则将消息路由到不同消费者的场景</li> <li>可靠传递：需要确保<strong>每条消息都被正确处理</strong>，适合对消息丢失敏感的场景</li></ul> <p>Kafka 使用场景</p> <ul><li>日志收集：适合收集和存储大量日志数据，例如应用程序日志、系统日志</li> <li>流处理：适合实时<strong>流处理场景</strong>，例如用户行为分析、实时推荐系统</li> <li>大数据管道：适合作为<strong>大数据</strong>生态系统的数据传输管道，例如将数据从生产系统传输到 Hadoop 或 Spark</li> <li>事件溯源：适合需要<strong>记录事件历史</strong>的场景，例如金融交易记录、审计日志（因为数据会写入磁盘进行持久化）</li></ul> <p>选择 RabbitMQ 的场景</p> <ul><li>你需要低延迟的消息传递</li> <li>你需要复杂的路由规则（如根据消息内容路由到不同消费者）</li> <li>你需要确保每条消息都被正确处理（如金融交易、订单处理）</li> <li>你的系统规模较小或中等，不需要处理海量数据</li></ul> <p>选择 Kafka 的场景</p> <ul><li>你需要高吞吐量的消息处理（如日志收集、用户行为分析）</li> <li>你需要持久化存储消息，并且可能需要回溯历史消息</li> <li>你需要流处理能力（如实时推荐、实时监控）</li> <li>你的系统规模较大，需要处理海量数据。</li></ul> <p>RabbitMQ 为什么 RabbitMQ 并发能力强于 Kafka 而 Kafka 吞吐量大于 RabbitMQ？</p> <p>首先回答吞吐量的问题</p> <ol><li>Kafka 的吞吐量高很大原因来自于其<strong>批处理</strong>设计，将多个消息打包成一个批次来减少网络和磁盘 I/O 的开销，相应的，这样处理的延迟会变大</li> <li>另外，Kafka 不仅仅是一个消息队列，它还提供了 Kafka Streams 和 Kafka Connect 等工具，用于实现<strong>流处理</strong>，从而大大提高数据处理速度</li></ol> <p>什么是批处理，什么是流处理？</p> <ul><li>批处理是指对<strong>静态的、有限的数据集</strong>进行处理。数据通常以文件或数据库表的形式存储，处理过程是周期性的（如每天、每小时）</li> <li>流处理是指对<strong>连续的、无限的数据流</strong>进行实时或近实时的处理。数据通常是动态生成的（如日志、传感器数据、用户行为数据）</li></ul> <p>💤 PS：流处理让我想到 Java Stream 流，虽然都叫“流”，但 Java Stream 实际上是一个用于对集合（Collection）数据进行函数式操作（如过滤、映射、排序、聚合等）的 API，提供一种更简洁、更高效的方式来处理集合数据（所谓函数式编程）</p> <p>而 RabbitMQ 的高并发显著强于 Kafka，首先我们要明确到底什么是并发能力强，并发能力强并不是只 QPS（Queries Per Second）高，1s 在计算机系统其实是一个比较大的时间跨度，以至于他反应的实际上是吞吐量而并非并发量</p> <p>所以，这里说 RabbitMQ 的高并发能力其实指的是低延迟的处理，进行快速的实时反馈</p> <h2 id="大数据计算"><a href="#大数据计算" class="header-anchor">#</a> 大数据计算</h2> <h3 id="flink"><a href="#flink" class="header-anchor">#</a> Flink</h3> <p>在大数据场景中，Flink 经常和 Kafka 搭配，用来消费 Kafka 的数据流</p> <ol><li>Kafka 生产数据（日志、用户点击、设备数据等）</li> <li>Flink 进行实时处理（聚合、分析、清洗）</li> <li>处理结果存入 Kafka（本地磁盘） / 关系型数据库 / Elasticsearch</li></ol> <p>📌 示例：Flink 读取 Kafka 并统计用户点击量</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FlinkKafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;user_clicks&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span>kafkaConsumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 统计每个用户的点击次数</span>
stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;Kafka Stream Processing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="spark"><a href="#spark" class="header-anchor">#</a> Spark</h3> <p>Flink 专注于流处理，而 Spark 以批处理为主</p> <table><thead><tr><th><strong>对比项</strong></th> <th><strong>Flink</strong></th> <th><strong>Spark</strong></th></tr></thead> <tbody><tr><td><strong>计算模式</strong></td> <td>主要是<strong>流计算</strong>，也支持批处理</td> <td>主要是<strong>批处理</strong>，支持流计算</td></tr> <tr><td><strong>延迟</strong></td> <td>毫秒级</td> <td>秒级</td></tr> <tr><td><strong>吞吐量</strong></td> <td>高吞吐，适用于高并发</td> <td>较高吞吐，但稍逊于 Flink</td></tr> <tr><td><strong>故障恢复</strong></td> <td>Exactly-Once 语义，保证数据一致性</td> <td>At-Least-Once，可能重复计算</td></tr> <tr><td><strong>API 兼容性</strong></td> <td>提供 SQL、Java、Python API</td> <td>提供 SQL、Scala、Java API</td></tr></tbody></table> <h2 id="elastic-栈"><a href="#elastic-栈" class="header-anchor">#</a> Elastic 栈</h2> <p><a href="https://www.cnblogs.com/buchizicai/p/17093719.html" target="_blank" rel="nofollow noopener noreferrer">ElasticSearch (ES从入门到精通一篇就够了) - 不吃紫菜 - 博客园<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="elk"><a href="#elk" class="header-anchor">#</a> ELK</h3> <p>ELK，Elastic Stack，是以 ElasticSearch 为核心的技术栈，包括 Beats、<strong>Logstash</strong>、Kibana、<strong>ElasticSerach</strong>，被广泛应用在日志数据分析、实时监控等领域</p> <img src="/assets/img/2729274-20230205171722024-1222796164.ed917391.png"> <p>作为 ELK 的核心，Elasticsearch 是一个分布式搜索引擎（索引数据库），负责存储、搜索、分析数据。他采用 Netty 作为底层通信框架，来实现高效的 <strong>TCP 连接管理</strong>和<strong>数据传输</strong>，由 Lucene 提供搜索引擎的核心 API</p> <ul><li>Lucene：Apache 的毕业开源搜索引擎类库，基于 Java 开发</li></ul> <p>相比于 Lucene，ElasticSearch 具备下列优点</p> <ol><li>支持分布式，可水平扩展</li> <li>提供 Restful 接口，可通过任意语言以 HTTP 方式调用</li></ol> <p>ES 的核心在于倒排索引（相对于关系型数据库的正向索引而言），在模糊搜索时速度很快（依仗于 BM25 算法）</p> <p>ES 的核心评分算法：一开始是 TF-IDF 算法</p> <img src="/assets/img/2729274-20230205173433826-368331600.e2c25075.png"> <p>后来是 BM25 算法（在 5.1 版本后），没错，就是这篇用到的 - <a href="https://northboat.github.io/pages/7bc025/#jpbc-%E5%9F%BA%E7%A1%80" target="_blank" rel="nofollow noopener noreferrer">基于 BM25 算法的可搜索加密系统 | 北船<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <img src="/assets/img/2729274-20230205173438720-1124832591.60253107.png"> <p>与 MySQL 的对比</p> <table><thead><tr><th><strong>MySQL</strong></th> <th><strong>Elasticsearch</strong></th> <th><strong>说明</strong></th></tr></thead> <tbody><tr><td>Table</td> <td>Index</td> <td>索引（index），就是文档的集合，类似数据库的表(table)</td></tr> <tr><td>Row</td> <td>Document</td> <td>文档（Document），就是一条条的数据，类似数据库中的行（Row），文档都是 JSON 格式</td></tr> <tr><td>Column</td> <td>Field</td> <td>字段（Field），就是 JSON 文档中的字段，类似数据库中的列（Column）</td></tr> <tr><td>Schema</td> <td>Mapping</td> <td>Mapping（映射）是索引中文档的约束，例如字段类型约束。类似数据库的表结构（Schema）</td></tr> <tr><td>SQL</td> <td>DSL</td> <td>DSL 是 elasticsearch 提供的JSON风格的请求语句，用来操作 elasticsearch，实现CRUD</td></tr></tbody></table> <p>像操纵 MySQL 一样，我们本质上都是使用 DSL 对 ES 进行 CRUD，无论是命令行还是调用 RestAPI，都是在完成这一工作</p> <h3 id="dsl"><a href="#dsl" class="header-anchor">#</a> DSL</h3> <p>类似于关系型数据库的 SQL，采用更为简单的 Json 格式</p> <p>1️⃣ POST 命令新增文档，全部是键值对的形式进行添加</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST /northboat/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;info&quot;</span><span class="token operator">:</span> <span class="token string">&quot;真相只有一个！&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;zy@itcast.cn&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;firstName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;柯&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;lastName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;南&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>2️⃣ GET 查询文档</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET /northboat/_doc/<span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>3️⃣ DELETE 删除文档</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code># 根据id删除数据
DELETE /northboat/_doc/<span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>4️⃣ PUT 全量修改文档（覆盖修改），实际上是先通过 id DELETE 掉原有文档，再 POST 一个相同 id 的文档</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>PUT /northboat/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;info&quot;</span><span class="token operator">:</span> <span class="token string">&quot;西电凯÷CIA实验室&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;zy@itcast.cn&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;firstName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;云&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;lastName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;赵&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>5️⃣ POST 增量修改，只修改指定 id 匹配的文档中的<strong>部分字段</strong></p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST /northboat/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;northboat@163.com&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="索引库设计"><a href="#索引库设计" class="header-anchor">#</a> 索引库设计</h3> <p>在现实场景中，我们不可能去手动创建索引库，应该是根据每个文档的关键词去创建对应的 json，那么这一过程一定是需要用到<strong>分词器</strong>对整个文档进行关键词的分割</p> <p>我们说，创建索引库，最关键的是 mapping 映射（构建 json 映射关系），而 mapping 映射要考虑的信息包括：</p> <ul><li>字段名</li> <li>字段数据类型</li> <li>是否参与搜索</li> <li>是否需要分词</li> <li>如果分词，分词器是什么</li></ul> <p>在设计时</p> <ol><li>依照关系型数据库的字段设计方式进行设计</li> <li>我们只对需要进行搜索的字段进行映射，比如主键肯定需要，而图片地址就无需参与</li> <li>分词器方面，可以统一使用 IK_MAX_WORD</li></ol> <p>一个 Hotel 酒店索引库示例，通过 PUT 命令创建</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>PUT /hotel
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;copy_to&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;address&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;price&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;score&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brand&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;copy_to&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;city&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;copy_to&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;starName&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;business&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;location&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;geo_point&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;pic&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;all&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>几个特殊字段说明</p> <ul><li>location：地理坐标，里面包含精度、纬度</li> <li>all：一个组合字段，其目的是将多字段的值 利用copy_to合并，提供给用户搜索</li></ul> <p>location 地理坐标</p> <img src="/assets/img/2729274-20230205172124085-626335563.d46fdaf8.png"> <p>copy_to 属性：将当前字段拷贝到指定字段</p> <img src="/assets/img/2729274-20230205172128097-289087887.b792eb38.png"> <p>当然了，在实际生产中，我们使用 Java API 来操作 ES 数据库：<a href="https://www.elastic.co/guide/en/elasticsearch/client/index.html" target="_blank" rel="nofollow noopener noreferrer">Elasticsearch Clients | Elastic<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="索引库-crud"><a href="#索引库-crud" class="header-anchor">#</a> 索引库 CRUD</h3> <p>引入 Java HighLevel Rest Client依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-rest-high-level-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>因为 SpringBoot 默认的 ES 版本是 7.6.2，所以我们需要覆盖默认的 ES 版本与自己的版本一致</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>7.12.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>初始化 RestHighLevelClient 并注入 Bean</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
        <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;http://192.168.150.101:9200&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这里为了单元测试方便，我们创建一个测试类HotelIndexTest，然后将初始化的代码编写在@BeforeEach方法中</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpHost</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestHighLevelClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AfterEach</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">BeforeEach</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelIndexTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;http://192.168.150.101:9200&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>CRUD 文档库 Hotel，本质上就是拼接字符串和 HTTP 请求，向 ES 数据库发送 DSL 命令，而后 ES 返回执行结果的过程</p> <h4 id="创建索引库"><a href="#创建索引库" class="header-anchor">#</a> 创建索引库</h4> <p>API 文档</p> <img src="/assets/img/2729274-20230205172138463-1252488196.102c4e0e.png"> <p>这里</p> <ul><li><code>CreateIndexRequest</code>估计就是对 RestTemplate 的一层封装，用于传输 HTTP 请求</li> <li><code>MAPPING_TEMPLATE</code>就是其对应的 DSL 语句，纯纯的一大段字符串，在某处定义一下然后使用就行</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>hotel<span class="token punctuation">.</span>constants</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelConstants</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MAPPING_TEMPLATE</span> <span class="token operator">=</span> <span class="token string">&quot;{\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;  \&quot;mappings\&quot;: {\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;    \&quot;properties\&quot;: {\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      \&quot;id\&quot;: {\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      },\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      \&quot;name\&quot;:{\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;,\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;copy_to\&quot;: \&quot;all\&quot;\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      },\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      \&quot;address\&quot;:{\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;index\&quot;: false\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      },\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      \&quot;price\&quot;:{\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      },\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      \&quot;score\&quot;:{\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      },\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      \&quot;brand\&quot;:{\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;copy_to\&quot;: \&quot;all\&quot;\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      },\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      \&quot;city\&quot;:{\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;copy_to\&quot;: \&quot;all\&quot;\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      },\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      \&quot;starName\&quot;:{\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      },\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      \&quot;business\&quot;:{\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      },\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      \&quot;location\&quot;:{\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;type\&quot;: \&quot;geo_point\&quot;\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      },\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      \&quot;pic\&quot;:{\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;index\&quot;: false\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      },\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      \&quot;all\&quot;:{\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;      }\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;    }\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;  }\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;}&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>然后使用该字符串（DSL）对 ES 进行操控</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">createHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.创建Request对象</span>
    <span class="token class-name">CreateIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;hotel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备请求的参数：DSL语句</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token constant">MAPPING_TEMPLATE</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="删除索引库"><a href="#删除索引库" class="header-anchor">#</a> 删除索引库</h4> <p>删除索引库并不需要长串的 DSL 语句，简单的<code>DELETE /hotel</code>即可，API 调用如下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testDeleteHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.创建Request对象</span>
    <span class="token class-name">DeleteIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;hotel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.发送请求</span>
    client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="查询索引库"><a href="#查询索引库" class="header-anchor">#</a> 查询索引库</h4> <p>类似于删除操作，DSL 为<code>GET /hotel</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testExistsHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.创建Request对象</span>
    <span class="token class-name">GetIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;hotel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.发送请求</span>
    <span class="token keyword">boolean</span> exists <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.输出</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exists <span class="token operator">?</span> <span class="token string">&quot;索引库已经存在！&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;索引库不存在！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="文档-crud"><a href="#文档-crud" class="header-anchor">#</a> 文档 CRUD</h3> <p>这里更多的是先读取 MySQL 中的数据，然后再存进 ES 中</p> <p>文档操作的基本步骤：根据发送请求那步的第一个参数，发过来判断需要创建什么<code>XXXRequest</code></p> <ol><li>初始化 RestHighLevelClient</li> <li>创建<code>XXXRequest</code>，XXX 可以是 Index、Get、Update、Delete、Bulk</li> <li>准备参数（Index、Update、Bulk时需要）</li> <li>发送请求：调用<code>RestHighLevelClient.xxx()</code>方法，xxx 是 index、get、update、delete、bulk</li> <li>解析结果（Get 时需要）</li></ol> <p>ES 的查询是一门功夫，类似于 SQL 的编写，可以有很多查询条件和复合嵌套规则，以后再学吧</p> <h3 id="logstash"><a href="#logstash" class="header-anchor">#</a> Logstash</h3> <p>Logstash 是一个流处理工具，它提供了大量插件，可用它自己的 <a href="https://www.elastic.co/guide/en/logstash/current/filter-plugins.html" target="_blank" rel="nofollow noopener noreferrer">Filter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 帮助你解析，丰富，转换和缓冲来自各种来源的数据，最后，它可以把自己的数据输出到各种需要的数据储存地，这其中包括 Elasticsearch</p> <ul><li>安恒这类安全类的公司做开发似乎用的比较多</li></ul> <h2 id="常见分布式问题"><a href="#常见分布式问题" class="header-anchor">#</a> 常见分布式问题</h2> <h3 id="分布式事务"><a href="#分布式事务" class="header-anchor">#</a> 分布式事务</h3> <p>2PC：两阶段提交，将事务的提交过程分为资源准备和资源提交两个阶段，并且由事务协调者来协调所有事务参与者，如果准备阶段所有事务参与者都预留资源成功，则进行第二阶段的资源提交，否则事务协调者回滚资源</p> <p>3PC：三阶段提交协议，是二阶段提交协议的改进版本，三阶段提交有两个改动点</p> <ol><li>在协调者和参与者中都引入超时机制</li> <li>在第一阶段和第二阶段中插入一个准备阶段，保证了在最后提交阶段之前各参与节点的状态是一致的</li></ol> <p>TCC：一种分布式事务处理方法，它的名称来自于其三个阶段<code>Try, Confirm, Cancel</code>，这种方法主要用于处理在分布式系统中，多个服务需要协同完成一项操作时的一致性问题</p> <h3 id="分布式锁"><a href="#分布式锁" class="header-anchor">#</a> 分布式锁</h3> <p>由于要保证分布式系统的性能，分布式锁一般都是乐观锁，与之对应的是悲观锁</p> <p>悲观锁是将资源锁住，等一个之前获得锁的线程释放锁之后，下一个线程才可以访问。而乐观锁采取了一种宽泛的态度，通过某种方式不加锁来处理资源，比如通过给记录加 version 或 timestamp 来操作数据（比如 CAS 策略），<strong>性能较悲观锁有很大的提高</strong></p> <ul><li>像 synchronized、Lock、ReadWriteLock 均为悲观锁</li> <li>而原子类例如 AtomicInteger 用的实际上是 CAS 机制，所以是一个乐观锁 → 但是没有引入版本控制，所以会出现 ABA 问题（A→B→A），详见 - <a href="https://northboat.github.io/pages/479c11/#%E4%BB%80%E4%B9%88%E6%98%AF-cas" target="_blank" rel="nofollow noopener noreferrer">原子性、单例模式和 CAS | 北船<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>还有一种乐观锁的理解：Git</p> <ul><li>我们只有在 push 的时候才会进行锁的检查，返回错误信息</li> <li>无论是 add 还是 commit，都是不上锁的（乐观的默认可执行），碰到问题（push 版本不对）再去解决</li></ul> <p>当然，我们在此处只讨论分布式锁的实现，需要明确的是，分布式锁既可以是悲观的也可以是乐观的，这要根据具体场景进行设计考量</p> <p>1️⃣ Redis 实现</p> <p>Redission，基于 Redis 集群的分布式锁，本质上就是维护同一个键值对，作为 Lock，获取时上锁，获取前检查这个键值对是否有锁，释放时解锁</p> <p>2️⃣ Zookeeper 实现</p> <p>订阅发布模式下，多个 Watcher 争用一个临时节点</p> <ul><li>上锁：创建临时节点</li> <li>释放：删除临时节点</li></ul> <h3 id="分布式会话"><a href="#分布式会话" class="header-anchor">#</a> 分布式会话</h3> <p>即在分布式系统的诸多后端接口之间维护<strong>唯一</strong>的用户 Session，可以用 Redis 存放用户 Session 并设置有效期实现，用 Redis 存 JWT 也行</p> <h3 id="分布式-id"><a href="#分布式-id" class="header-anchor">#</a> 分布式 ID</h3> <p>在分布式系统中，要保证 ID 的唯一性，粗糙方案</p> <ol><li>UUID：空间大，无序</li> <li>数据库自增 ID：性能差，单点故障</li></ol> <p>较好的方案</p> <ol><li>Redis 自增 ID：多机设置不同初始 ID 和不同步长</li> <li>雪花算法（Snowflake）
<ul><li>生成 64 位的 ID，包含时间戳、机器 ID 和序列号</li> <li>高性能、有序，但依赖时钟同步</li></ul></li></ol> <h3 id="分布式链路追踪"><a href="#分布式链路追踪" class="header-anchor">#</a> 分布式链路追踪</h3> <p>唉，下次再说吧</p></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2025/04/14, 19:24:35</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/9a8ad9/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">分布式系统设计（一）</div></a> <a href="/pages/2afee4/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">分布式系统设计（三）</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/9a8ad9/" class="prev">分布式系统设计（一）</a></span> <span class="next"><a href="/pages/2afee4/">分布式系统设计（三）</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/ceab3a/"><div>
            Jenkins
            <!----></div></a> <span class="date">4-14</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/be085d/"><div>
            Kubernetes
            <!----></div></a> <span class="date">4-4</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/fc0f4e/"><div>
            Go 微服务开发
            <!----></div></a> <span class="date">4-1</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:Arkrypto@qq.com" title="邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/Arkrypto" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/my/m/music/playlist?id=5123040741" title="音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2025
    <span>Arkrypto | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div class="reco-bgm-panel" data-v-b1d3339e><audio id="bgm" src="/song/枫.mp3" data-v-b1d3339e></audio> <div class="reco-float-box" style="bottom:10px;z-index:999999;display:none;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><img src="/img/error.jpg" data-v-b1d3339e></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="reco-bgm-cover" style="background-image:url(/img/error.jpg);" data-v-b1d3339e><div class="mini-operation" style="display:none;" data-v-b1d3339e><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-b1d3339e></i></div> <div class="falut-message" style="display:none;" data-v-b1d3339e>
          播放失败
        </div></div> <div class="reco-bgm-info" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-music music" data-v-b1d3339e></i>枫</div> <div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-artist" data-v-b1d3339e></i>常颖杰</div> <div class="reco-bgm-progress" data-v-b1d3339e><div class="progress-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div> <div class="reco-bgm-operation" data-v-b1d3339e><i class="reco-bgm reco-bgm-last last" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play play" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-next next" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-b1d3339e></i> <div class="volume-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div></div> <div class="reco-bgm-left-box" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><i class="reco-bgm reco-bgm-left" data-v-b1d3339e></i></div></div></div></div></div>
    <script src="/assets/js/app.f341c693.js" defer></script><script src="/assets/js/3.65b33734.js" defer></script><script src="/assets/js/34.24f5e7a5.js" defer></script><script src="/assets/js/39.97abe7b7.js" defer></script>
  </body>
</html>
