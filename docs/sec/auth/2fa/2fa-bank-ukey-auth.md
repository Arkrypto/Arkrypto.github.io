---
title: "UKEY - 常见安全的 2FA 实现"
date: 2024-6-22
tags:
  - Authentication
---

## 什么是 2FA？

2FA，Two-Factor Authentication，即双因素认证

- 传统的账号密码为单重认证，如 QQ 的登录；Stream 的登录则为双因素，一重为账号密码，二为手机接收的认证码短信

密码 + 某种个人物品是常见的双因素组合，如银行使用的 U 盾（一个 U 盘），在此处 U 盾 充当“某种个人物品”的作用，每位用户将配备各自的 U 盾，内置有用户的签名证书与加密证书，同时 U 盾的访问受 PIN 码保护

一种典型实现方案为

- 用户在完成口令、验证码的输入后，前端调用 USBKEY 的接口对登录请求数据进行签名，并且将该签名作为一个字段加入 HTTP 请求中
- 后端系统会部署一个签名验签服务器，接收到前端登录请求后，利用签名验签服务器完成验签，验签正确则身份鉴别通过，而后再进行密码的认证，实现双因素认证

本文采用奥联的 USBKEY 以及其相对应的密码机实现 U 盾的 2FA 认证。真的不得不说，奥联给的接口简直是一坨大芬🤮，文档更是牛头不对马嘴

## 实现

具体实现的前置工作

- 用户 UKEY 中所使用的签名证书需要在后端签名验签服务器中登记在案
- UKEY 的插件环境需要用户自行下载安装
- 后端服务器对于签名验签服务器的访问需要额外的证书`server.cer`以及密码
- 需要一个倒霉蛋将 UKEY 从西安邮到秦皇岛......

### 签名

采用 WebSocket 形式的接口（异步回调）对前端表单数据进行 SGD_SM3_SM2 进行签名，该 UKEY 接口内部写死 SignerID 为`"1234567812345678"`（该算法默认标准 ），在后续验签时需保持一致

### 验签

前端将原始表单数据（原文）和签名数据（密文）一同打在后端接口上，后端接收到请求后，首先根据用户名从数据库中取出用户证书，再对前端传来的原文和密文通过证书和签名验签服务器进行验证，返回`true/false`，实现一重认证

而后的二重认证就是传统的密码认证，不再赘述

## 后记

关于这个方案，用户不可能随时携带 U 盾，手机才是最好的替代品。密码 + 手机就成了最佳的双因素认证方案（from 阮一峰）

另外，奥联的接口，谁用谁知道，无敌了



